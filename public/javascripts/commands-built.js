/**
 * KineticJS JavaScript Library core
 * http://www.kineticjs.com/
 * Copyright 2012, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Jul 11 2012
 *
 * Copyright (C) 2011 - 2012 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

// Underscore.js 1.3.3
// (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Underscore is freely distributable under the MIT license.
// Portions of Underscore are inspired or borrowed from Prototype,
// Oliver Steele's Functional, and John Resig's Micro-Templating.
// For all details and documentation:
// http://documentcloud.github.com/underscore

var Kinetic={};Kinetic.Global={BUBBLE_WHITELIST:["mousedown","mousemove","mouseup","mouseover","mouseout","click","dblclick","touchstart","touchmove","touchend","tap","dbltap","dragstart","dragmove","dragend"],stages:[],idCounter:0,tempNodes:[],maxDragTimeInterval:20,drag:{moving:!1,offset:{x:0,y:0},lastDrawTime:0},_pullNodes:function(e){var t=this.tempNodes;for(var n=0;n<t.length;n++){var r=t[n];r.getStage()!==undefined&&r.getStage()._id===e._id&&(e._addId(r),e._addName(r),this.tempNodes.splice(n,1),n-=1)}}},Kinetic.Type={_isElement:function(e){return!!e&&e.nodeType==1},_isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},_isArray:function(e){return Object.prototype.toString.call(e)=="[object Array]"},_isObject:function(e){return!!e&&e.constructor==Object},_isNumber:function(e){return Object.prototype.toString.call(e)=="[object Number]"},_hasMethods:function(e){var t=[];for(var n in e)this._isFunction(e[n])&&t.push(n);return t.length>0},_getXY:function(e){if(this._isNumber(e))return{x:e,y:e};if(this._isArray(e)){if(e.length===1){var t=e[0];if(this._isNumber(t))return{x:t,y:t};if(this._isArray(t))return{x:t[0],y:t[1]};if(this._isObject(t))return t}else if(e.length>=2)return{x:e[0],y:e[1]}}else if(this._isObject(e))return e;return{x:0,y:0}},_getSize:function(e){if(this._isNumber(e))return{width:e,height:e};if(this._isArray(e))if(e.length===1){var t=e[0];if(this._isNumber(t))return{width:t,height:t};if(this._isArray(t)){if(t.length>=4)return{width:t[2],height:t[3]};if(t.length>=2)return{width:t[0],height:t[1]}}else if(this._isObject(t))return t}else{if(e.length>=4)return{width:e[2],height:e[3]};if(e.length>=2)return{width:e[0],height:e[1]}}else if(this._isObject(e))return e;return{width:0,height:0}},_getPoints:function(e){if(e===undefined)return[];if(this._isObject(e[0]))return e;var t=[];for(var n=0;n<e.length;n+=2)t.push({x:e[n],y:e[n+1]});return t}},function(){var e=!1;Kinetic.Class=function(){},Kinetic.Class.extend=function(t){function n(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in t)i[s]=typeof t[s]=="function"&&typeof r[s]=="function"?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,t[s]):t[s];return n.prototype=i,n.prototype.constructor=n,n.extend=arguments.callee,n}}(),Kinetic.Animation={animations:[],animIdCounter:0,animRunning:!1,frame:{time:0,timeDiff:0,lastTime:0},_addAnimation:function(e){e.id=this.animIdCounter++,this.animations.push(e)},_removeAnimation:function(e){var t=e.id,n=this.animations;for(var r=0;r<n.length;r++)if(n[r].id===t)return this.animations.splice(r,1),!1},_runFrames:function(){var e={};for(var t=0;t<this.animations.length;t++){var n=this.animations[t];n.node&&n.node._id!==undefined&&(e[n.node._id]=n.node),n.func&&n.func(this.frame)}for(var r in e)e[r].draw()},_updateFrameObject:function(){var e=new Date,t=e.getTime();this.frame.lastTime===0?this.frame.lastTime=t:(this.frame.timeDiff=t-this.frame.lastTime,this.frame.lastTime=t,this.frame.time+=this.frame.timeDiff)},_animationLoop:function(){if(this.animations.length>0){this._updateFrameObject(),this._runFrames();var e=this;requestAnimFrame(function(){e._animationLoop()})}else this.animRunning=!1,this.frame.lastTime=0},_handleAnimation:function(){var e=this;this.animRunning?this.frame.lastTime=0:(this.animRunning=!0,e._animationLoop())}},requestAnimFrame=function(e){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),Kinetic.Node=Kinetic.Class.extend({init:function(e){this.defaultNodeAttrs={visible:!0,listening:!0,name:undefined,alpha:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},dragConstraint:"none",dragBounds:{},draggable:!1},this.setDefaultAttrs(this.defaultNodeAttrs),this.eventListeners={},this.setAttrs(e),this.on("draggableChange.kinetic",function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var e=this.getStage(),t=Kinetic.Global;e&&t.drag.node&&t.drag.node._id===this._id&&e._endDrag()}}),this.simulate("draggableChange")},on:function(e,t){var n=e.split(" ");for(var r=0;r<n.length;r++){var i=n[r],s=i,o=s.split("."),u=o[0],a=o.length>1?o[1]:"";this.eventListeners[u]||(this.eventListeners[u]=[]),this.eventListeners[u].push({name:a,handler:t})}},off:function(e){var t=e.split(" ");for(var n=0;n<t.length;n++){var r=t[n],i=r,s=i.split("."),o=s[0];if(this.eventListeners[o]&&s.length>1){var u=s[1];for(var a=0;a<this.eventListeners[o].length;a++)if(this.eventListeners[o][a].name===u){this.eventListeners[o].splice(a,1);if(this.eventListeners[o].length===0){delete this.eventListeners[o];break}a--}}else delete this.eventListeners[o]}},getAttrs:function(){return this.attrs},setDefaultAttrs:function(e){this.attrs===undefined&&(this.attrs={});if(e)for(var t in e)this.attrs[t]===undefined&&(this.attrs[t]=e[t])},setAttrs:function(e){var t=Kinetic.Type,n=this;if(e!==undefined){function r(e,i,s){for(var o in i){var u=i[o];e[o]===undefined&&u!==undefined&&(e[o]={});if(t._isObject(u)&&!t._isArray(u)&&!t._isElement(u)&&!t._hasMethods(u))Kinetic.Type._isObject(e[o])||(e[o]={}),r(e[o],u,s+1);else switch(o){case"rotationDeg":n._setAttr(e,"rotation",i[o]*Math.PI/180),o="rotation";break;case"offset":var a=t._getXY(u);n._setAttr(e[o],"x",a.x),n._setAttr(e[o],"y",a.y);break;case"scale":var a=t._getXY(u);n._setAttr(e[o],"x",a.x),n._setAttr(e[o],"y",a.y);break;case"points":n._setAttr(e,o,t._getPoints(u));break;case"crop":var a=t._getXY(u),f=t._getSize(u);n._setAttr(e[o],"x",a.x),n._setAttr(e[o],"y",a.y),n._setAttr(e[o],"width",f.width),n._setAttr(e[o],"height",f.height);break;default:n._setAttr(e,o,u)}s===0&&n._fireChangeEvent(o)}}r(this.attrs,e,0)}},isVisible:function(){return this.attrs.visible&&this.getParent()&&!this.getParent().isVisible()?!1:this.attrs.visible},show:function(){this.setAttrs({visible:!0})},hide:function(){this.setAttrs({visible:!1})},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function e(n){var s=[];for(var o=0;o<n.length;o++){var u=n[o];i++,u.nodeType!=="Shape"&&(s=s.concat(u.getChildren())),u._id===r._id&&(o=n.length)}s.length>0&&s[0].getLevel()<=t&&e(s)}var t=this.getLevel(),n=this.getStage(),r=this,i=0;return r.nodeType!=="Stage"&&e(r.getStage().getChildren()),i},getLevel:function(){var e=0,t=this.parent;while(t)e++,t=t.parent;return e},setPosition:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));this.setAttrs(e)},getPosition:function(){return{x:this.attrs.x,y:this.attrs.y}},getAbsolutePosition:function(){return this.getAbsoluteTransform().getTranslation()},setAbsolutePosition:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=this.attrs.rotation,n={x:this.attrs.scale.x,y:this.attrs.scale.y},r={x:this.attrs.offset.x,y:this.attrs.offset.y};this.attrs.rotation=0,this.attrs.scale={x:1,y:1};var i=this.getAbsoluteTransform();i.invert(),i.translate(e.x,e.y),e={x:this.attrs.x+i.getTranslation().x,y:this.attrs.y+i.getTranslation().y},this.setPosition(e.x,e.y),this.rotate(t),this.attrs.scale={x:n.x,y:n.y}},move:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=this.getX(),n=this.getY();e.x!==undefined&&(t+=e.x),e.y!==undefined&&(n+=e.y),this.setAttrs({x:t,y:n})},getRotationDeg:function(){return this.attrs.rotation*180/Math.PI},rotate:function(e){this.setAttrs({rotation:this.getRotation()+e})},rotateDeg:function(e){this.setAttrs({rotation:this.getRotation()+e*Math.PI/180})},moveToTop:function(){var e=this.index;this.parent.children.splice(e,1),this.parent.children.push(this),this.parent._setChildrenIndices()},moveUp:function(){var e=this.index;this.parent.children.splice(e,1),this.parent.children.splice(e+1,0,this),this.parent._setChildrenIndices()},moveDown:function(){var e=this.index;e>0&&(this.parent.children.splice(e,1),this.parent.children.splice(e-1,0,this),this.parent._setChildrenIndices())},moveToBottom:function(){var e=this.index;this.parent.children.splice(e,1),this.parent.children.unshift(this),this.parent._setChildrenIndices()},setZIndex:function(e){var t=this.index;this.parent.children.splice(t,1),this.parent.children.splice(e,0,this),this.parent._setChildrenIndices()},getAbsoluteAlpha:function(){var e=1,t=this;while(t.nodeType!=="Stage")e*=t.attrs.alpha,t=t.parent;return e},isDragging:function(){var e=Kinetic.Global;return e.drag.node!==undefined&&e.drag.node._id===this._id&&e.drag.moving},moveTo:function(e){var t=this.parent;t.children.splice(this.index,1),t._setChildrenIndices(),e.children.push(this),this.index=e.children.length-1,this.parent=e,e._setChildrenIndices()},getParent:function(){return this.parent},getLayer:function(){return this.nodeType==="Layer"?this:this.getParent().getLayer()},getStage:function(){return this.nodeType!=="Stage"&&this.getParent()?this.getParent().getStage():this.nodeType==="Stage"?this:undefined},simulate:function(e){this._handleEvent(e,{})},transitionTo:function(e){var t=Kinetic.Animation;this.transAnim&&(t._removeAnimation(this.transAnim),this.transAnim=null);var n=this.nodeType==="Stage"?this:this.getLayer(),r=this,i=new Kinetic.Transition(this,e),s={func:function(){i._onEnterFrame()},node:n};return this.transAnim=s,t._addAnimation(s),i.onFinished=function(){t._removeAnimation(s),r.transAnim=null,e.callback!==undefined&&e.callback(),s.node.draw()},i.start(),t._handleAnimation(),i},getAbsoluteTransform:function(){var e=new Kinetic.Transform,t=[],n=this.parent;t.unshift(this);while(n)t.unshift(n),n=n.parent;for(var r=0;r<t.length;r++){var i=t[r],s=i.getTransform();e.multiply(s)}return e},getTransform:function(){var e=new Kinetic.Transform;return(this.attrs.x!==0||this.attrs.y!==0)&&e.translate(this.attrs.x,this.attrs.y),this.attrs.rotation!==0&&e.rotate(this.attrs.rotation),(this.attrs.scale.x!==1||this.attrs.scale.y!==1)&&e.scale(this.attrs.scale.x,this.attrs.scale.y),e},clone:function(e){var t=this.shapeType||this.nodeType,n=new Kinetic[t](this.attrs);for(var r in this.eventListeners){var i=this.eventListeners[r];for(var s=0;s<i.length;s++){var o=i[s];o.name.indexOf("kinetic")<0&&(n.eventListeners[r]||(n.eventListeners[r]=[]),n.eventListeners[r].push(o))}}return n.setAttrs(e),n},_fireChangeEvent:function(e){this._handleEvent(e+"Change",{})},_setAttr:function(e,t,n){n!==undefined&&(e===undefined&&(e={}),e[t]=n)},_listenDrag:function(){this._dragCleanup();var e=Kinetic.Global,t=this;this.on("mousedown.kinetic touchstart.kinetic",function(e){t._initDrag()})},_initDrag:function(){var e=Kinetic.Global,t=this.getStage(),n=t.getUserPosition();if(n){var r=this.getTransform().getTranslation(),i=this.getAbsoluteTransform().getTranslation();e.drag.node=this,e.drag.offset.x=n.x-this.getAbsoluteTransform().getTranslation().x,e.drag.offset.y=n.y-this.getAbsoluteTransform().getTranslation().y}},_dragCleanup:function(){this.off("mousedown.kinetic"),this.off("touchstart.kinetic")},_handleEvent:function(e,t){this.nodeType==="Shape"&&(t.shape=this);var n=this.getStage(),r=n?n.mouseoverShape:null,i=n?n.mouseoutShape:null,s=this.eventListeners,o=!0;e==="mouseover"&&i&&i._id===this._id?o=!1:e==="mouseout"&&r&&r._id===this._id&&(o=!1);if(o){if(s[e]){var u=s[e];for(var a=0;a<u.length;a++)u[a].handler.apply(this,[t])}n&&r&&i&&(n.mouseoverShape=r.parent,n.mouseoutShape=i.parent),Kinetic.Global.BUBBLE_WHITELIST.indexOf(e)>=0&&!t.cancelBubble&&this.parent&&this._handleEvent.call(this.parent,e,t)}}}),Kinetic.Node.addSetters=function(e,t){for(var n=0;n<t.length;n++){var r=t[n];this._addSetter(e,r)}},Kinetic.Node.addGetters=function(e,t){for(var n=0;n<t.length;n++){var r=t[n];this._addGetter(e,r)}},Kinetic.Node.addGettersSetters=function(e,t){this.addSetters(e,t),this.addGetters(e,t)},Kinetic.Node._addSetter=function(e,t){var n=this,r="set"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(){var e;arguments.length==1?e=arguments[0]:e=Array.prototype.slice.call(arguments);var n={};n[t]=e,this.setAttrs(n)}},Kinetic.Node._addGetter=function(e,t){var n=this,r="get"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(e){return this.attrs[t]}},Kinetic.Node.addGettersSetters(Kinetic.Node,["x","y","scale","detectionType","rotation","alpha","name","id","offset","draggable","dragConstraint","dragBounds","listening"]),Kinetic.Node.addSetters(Kinetic.Node,["rotationDeg"]),Kinetic.Container=Kinetic.Node.extend({init:function(e){this.children=[],this._super(e)},getChildren:function(){return this.children},removeChildren:function(){while(this.children.length>0)this.remove(this.children[0])},add:function(e){e._id=Kinetic.Global.idCounter++,e.index=this.children.length,e.parent=this,this.children.push(e);var t=e.getStage();if(t===undefined){var n=Kinetic.Global;n.tempNodes.push(e)}else{t._addId(e),t._addName(e);var n=Kinetic.Global;n._pullNodes(t)}return this._add!==undefined&&this._add(e),this},remove:function(e){if(e&&e.index!==undefined&&this.children[e.index]._id==e._id){var t=this.getStage();t!==undefined&&(t._removeId(e),t._removeName(e));var n=Kinetic.Global;for(var r=0;r<n.tempNodes.length;r++){var i=n.tempNodes[r];if(i._id===e._id){n.tempNodes.splice(r,1);break}}this.children.splice(e.index,1),this._setChildrenIndices();while(e.children&&e.children.length>0)e.remove(e.children[0]);this._remove!==undefined&&this._remove(e)}return this},get:function(e){var t=this.getStage(),n,r=e.slice(1);if(e.charAt(0)==="#")n=t.ids[r]!==undefined?[t.ids[r]]:[];else{if(e.charAt(0)!==".")return e==="Shape"||e==="Group"||e==="Layer"?this._getNodes(e):!1;n=t.names[r]!==undefined?t.names[r]:[]}var i=[];for(var s=0;s<n.length;s++){var o=n[s];this.isAncestorOf(o)&&i.push(o)}return i},isAncestorOf:function(e){if(this.nodeType==="Stage")return!0;var t=e.getParent();while(t){if(t._id===this._id)return!0;t=t.getParent()}return!1},getIntersections:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=[],n=this.get("Shape");for(var r=0;r<n.length;r++){var i=n[r];i.isVisible()&&i.intersects(e)&&t.push(i)}return t},_getNodes:function(e){function t(r){var i=r.getChildren();for(var s=0;s<i.length;s++){var o=i[s];o.nodeType===e?n.push(o):o.nodeType!=="Shape"&&t(o)}}var n=[];return t(this),n},_drawChildren:function(){var e=this.getStage(),t=this.children;for(var n=0;n<t.length;n++){var r=t[n];r.nodeType==="Shape"?r.isVisible()&&e.isVisible()&&r._draw(r.getLayer()):r.draw()}},_setChildrenIndices:function(){if(this.nodeType==="Stage"){var e=this.content.children,t=e[0],n=e[1];this.content.innerHTML="",this.content.appendChild(t),this.content.appendChild(n)}for(var r=0;r<this.children.length;r++)this.children[r].index=r,this.nodeType==="Stage"&&this.content.appendChild(this.children[r].canvas)}}),Kinetic.Stage=Kinetic.Container.extend({init:function(e){this.setDefaultAttrs({width:400,height:200,throttle:80}),typeof e.container=="string"&&(e.container=document.getElementById(e.container)),this._super(e),this._setStageDefaultProperties(),this._id=Kinetic.Global.idCounter++,this._buildDOM(),this._bindContentEvents(),this.on("widthChange.kinetic",function(){this._resizeDOM()}),this.on("heightChange.kinetic",function(){this._resizeDOM()});var t=Kinetic.Global;t.stages.push(this),this._addId(this),this._addName(this)},onFrame:function(e){this.anim={func:e}},start:function(){if(!this.animRunning){var e=Kinetic.Animation;e._addAnimation(this.anim),e._handleAnimation(),this.animRunning=!0}},stop:function(){Kinetic.Animation._removeAnimation(this.anim),this.animRunning=!1},draw:function(){this._drawChildren()},setSize:function(){var e=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(e)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}},clear:function(){var e=this.children;for(var t=0;t<e.length;t++)e[t].clear()},toDataURL:function(e,t,n){function r(u){var l=o[u].getCanvas().toDataURL(),p=new Image;p.onload=function(){s.drawImage(this,0,0),u++;if(u<o.length)r(u);else try{e(i.getCanvas().toDataURL(t,n))}catch(l){e(i.getCanvas().toDataURL())}},p.src=l}var i=this.bufferLayer,s=i.getContext(),o=this.children,u=this;i.clear(),r(0)},toJSON:function(){function e(n){var r={};r.attrs={};for(var i in n.attrs){var s=n.attrs[i];!t._isFunction(s)&&!t._isElement(s)&&!t._hasMethods(s)&&(r.attrs[i]=s)}r.nodeType=n.nodeType,r.shapeType=n.shapeType;if(n.nodeType!=="Shape"){r.children=[];var o=n.getChildren();for(var u=0;u<o.length;u++){var f=o[u];r.children.push(e(f))}}return r}var t=Kinetic.Type;return JSON.stringify(e(this))},reset:function(){this.removeChildren(),this._setStageDefaultProperties(),this.setAttrs(this.defaultNodeAttrs)},load:function(e){function t(e,n){var r=n.children;if(r!==undefined)for(var i=0;i<r.length;i++){var s=r[i],o;s.nodeType==="Shape"?s.shapeType===undefined?o="Shape":o=s.shapeType:o=s.nodeType;var u=new Kinetic[o](s.attrs);e.add(u),t(u,s)}}this.reset();var n=JSON.parse(e);this.attrs=n.attrs,t(this,n),this.draw()},getMousePosition:function(e){return this.mousePos},getTouchPosition:function(e){return this.touchPos},getUserPosition:function(e){return this.getTouchPosition()||this.getMousePosition()},getContainer:function(){return this.attrs.container},getStage:function(){return this},getDOM:function(){return this.content},_resizeDOM:function(){var e=this.attrs.width,t=this.attrs.height;this.content.style.width=e+"px",this.content.style.height=t+"px",this.bufferLayer.getCanvas().width=e,this.bufferLayer.getCanvas().height=t,this.pathLayer.getCanvas().width=e,this.pathLayer.getCanvas().height=t;var n=this.children;for(var r=0;r<n.length;r++){var i=n[r];i.getCanvas().width=e,i.getCanvas().height=t,i.draw()}},_remove:function(e){try{this.content.removeChild(e.canvas)}catch(t){}},_add:function(e){e.canvas.width=this.attrs.width,e.canvas.height=this.attrs.height,e.draw(),this.content.appendChild(e.canvas),e.lastDrawTime=0},_detectEvent:function(e,t){var n=Kinetic.Global.drag.moving,r=Kinetic.Global,i=this.getUserPosition(),s=e.eventListeners,o=this;this.targetShape&&e._id===this.targetShape._id&&(this.targetFound=!0);if(e.isVisible()&&i!==undefined&&e.intersects(i)){if(!n&&this.mouseDown)return this.mouseDown=!1,this.clickStart=!0,e._handleEvent("mousedown",t),!0;if(this.mouseUp)return this.mouseUp=!1,e._handleEvent("mouseup",t),this.clickStart&&(!r.drag.moving||!r.drag.node)&&(e._handleEvent("click",t),this.inDoubleClickWindow&&e._handleEvent("dblclick",t),this.inDoubleClickWindow=!0,setTimeout(function(){o.inDoubleClickWindow=!1},this.dblClickWindow)),!0;if(!n&&this.touchStart&&!this.touchMove)return this.touchStart=!1,this.tapStart=!0,e._handleEvent("touchstart",t),!0;if(this.touchEnd)return this.touchEnd=!1,e._handleEvent("touchend",t),this.tapStart&&(!r.drag.moving||!r.drag.node)&&(e._handleEvent("tap",t),this.inDoubleClickWindow&&e._handleEvent("dbltap",t),this.inDoubleClickWindow=!0,setTimeout(function(){o.inDoubleClickWindow=!1},this.dblClickWindow)),!0;if(!n&&this.touchMove)return e._handleEvent("touchmove",t),!0;if(!n&&this._isNewTarget(e,t))return this.mouseoutShape&&(this.mouseoverShape=e,this.mouseoutShape._handleEvent("mouseout",t),this.mouseoverShape=undefined),e._handleEvent("mouseover",t),this._setTarget(e),!0;if(!n&&this.mouseMove)return e._handleEvent("mousemove",t),!0}else if(!n&&this.targetShape&&this.targetShape._id===e._id)return this._setTarget(undefined),this.mouseoutShape=e,!0;return!1},_setTarget:function(e){this.targetShape=e,this.targetFound=!0},_isNewTarget:function(e,t){if(!this.targetShape||!this.targetFound&&e._id!==this.targetShape._id){if(this.targetShape){var n=this.targetShape.eventListeners;n&&(this.mouseoutShape=this.targetShape)}return!0}return!1},_traverseChildren:function(e,t){var n=e.children;for(var r=n.length-1;r>=0;r--){var i=n[r];if(i.getListening())if(i.nodeType==="Shape"){var s=this._detectEvent(i,t);if(s)return!0}else{var s=this._traverseChildren(i,t);if(s)return!0}}return!1},_handleStageEvent:function(e){var t=new Date,n=t.getTime();this.lastEventTime=n;var r=Kinetic.Global;e||(e=window.event),this._setMousePosition(e),this._setTouchPosition(e),this.pathLayer.clear(),this.targetFound=!1;var i=!1;for(var s=this.children.length-1;s>=0;s--){var o=this.children[s];if(o.isVisible()&&s>=0&&o.getListening()&&this._traverseChildren(o,e)){i=!0;break}}!i&&this.mouseoutShape&&(this.mouseoutShape._handleEvent("mouseout",e),this.mouseoutShape=undefined)},_bindContentEvents:function(){var e=Kinetic.Global,t=this,n=["mousedown","mousemove","mouseup","mouseover","mouseout","touchstart","touchmove","touchend"];for(var r=0;r<n.length;r++){var i=n[r];(function(){var e=i;t.content.addEventListener(e,function(n){t["_"+e](n)},!1)})()}},_mouseover:function(e){this._handleStageEvent(e)},_mouseout:function(e){var t=this.targetShape;t&&(t._handleEvent("mouseout",e),this.targetShape=undefined),this.mousePos=undefined,this._endDrag(e)},_mousemove:function(e){var t=this.attrs.throttle,n=new Date,r=n.getTime(),i=r-this.lastEventTime,s=1e3/t;if(i>=s||t>200)this.mouseDown=!1,this.mouseUp=!1,this.mouseMove=!0,this._handleStageEvent(e);this._startDrag(e)},_mousedown:function(e){this.mouseDown=!0,this.mouseUp=!1,this.mouseMove=!1,this._handleStageEvent(e),this.attrs.draggable&&this._initDrag()},_mouseup:function(e){this.mouseDown=!1,this.mouseUp=!0,this.mouseMove=!1,this._handleStageEvent(e),this.clickStart=!1,this._endDrag(e)},_touchstart:function(e){e.preventDefault(),this.touchStart=!0,this.touchEnd=!1,this.touchMove=!1,this._handleStageEvent(e),this.attrs.draggable&&this._initDrag()},_touchend:function(e){this.touchStart=!1,this.touchEnd=!0,this.touchMove=!1,this._handleStageEvent(e),this.tapStart=!1,this._endDrag(e)},_touchmove:function(e){var t=this,n=this.attrs.throttle,r=new Date,i=r.getTime(),s=i-this.lastEventTime,o=1e3/n;if(s>=o||n>200)e.preventDefault(),t.touchEnd=!1,t.touchMove=!0,t._handleStageEvent(e);this._startDrag(e)},_setMousePosition:function(e){var t=e.offsetX||e.clientX-this._getContentPosition().left+window.pageXOffset,n=e.offsetY||e.clientY-this._getContentPosition().top+window.pageYOffset;this.mousePos={x:t,y:n}},_setTouchPosition:function(e){if(e.touches!==undefined&&e.touches.length===1){var t=e.touches[0],n=t.clientX-this._getContentPosition().left+window.pageXOffset,r=t.clientY-this._getContentPosition().top+window.pageYOffset;this.touchPos={x:n,y:r}}},_getContentPosition:function(){var e=this.content,t=0,n=0;while(e&&e.tagName!=="BODY")t+=e.offsetTop-e.scrollTop,n+=e.offsetLeft-e.scrollLeft,e=e.offsetParent;return{top:t,left:n}},_modifyPathContext:function(e){e.stroke=function(){},e.fill=function(){},e.fillRect=function(t,n,r,i){e.rect(t,n,r,i)},e.strokeRect=function(t,n,r,i){e.rect(t,n,r,i)},e.drawImage=function(){},e.fillText=function(){},e.strokeText=function(){}},_endDrag:function(e){var t=Kinetic.Global;t.drag.node&&t.drag.moving&&(t.drag.moving=!1,t.drag.node._handleEvent("dragend",e)),t.drag.node=undefined},_startDrag:function(e){var t=this,n=Kinetic.Global,r=n.drag.node;if(r){var i=t.getUserPosition(),s=r.attrs.dragConstraint,o=r.attrs.dragBounds,u={x:r.attrs.x,y:r.attrs.y},a={x:i.x-n.drag.offset.x,y:i.y-n.drag.offset.y};o.left!==undefined&&a.x<o.left&&(a.x=o.left),o.right!==undefined&&a.x>o.right&&(a.x=o.right),o.top!==undefined&&a.y<o.top&&(a.y=o.top),o.bottom!==undefined&&a.y>o.bottom&&(a.y=o.bottom),r.setAbsolutePosition(a),s==="horizontal"?r.attrs.y=u.y:s==="vertical"&&(r.attrs.x=u.x),n.drag.node.nodeType==="Stage"?n.drag.node.draw():n.drag.node.getLayer().draw(),n.drag.moving||(n.drag.moving=!0,n.drag.node._handleEvent("dragstart",e)),n.drag.node._handleEvent("dragmove",e)}},_buildDOM:function(){this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.display="inline-block",this.content.className="kineticjs-content",this.attrs.container.appendChild(this.content),this.bufferLayer=new Kinetic.Layer({name:"bufferLayer"}),this.pathLayer=new Kinetic.Layer({name:"pathLayer"}),this.bufferLayer.parent=this,this.pathLayer.parent=this,this._modifyPathContext(this.pathLayer.context),this.bufferLayer.getCanvas().style.display="none",this.pathLayer.getCanvas().style.display="none",this.bufferLayer.canvas.className="kineticjs-buffer-layer",this.content.appendChild(this.bufferLayer.canvas),this.pathLayer.canvas.className="kineticjs-path-layer",this.content.appendChild(this.pathLayer.canvas),this.setSize(this.attrs.width,this.attrs.height),this._resizeDOM()},_addId:function(e){e.attrs.id!==undefined&&(this.ids[e.attrs.id]=e)},_removeId:function(e){e.attrs.id!==undefined&&delete this.ids[e.attrs.id]},_addName:function(e){var t=e.attrs.name;t!==undefined&&(this.names[t]===undefined&&(this.names[t]=[]),this.names[t].push(e))},_removeName:function(e){if(e.attrs.name!==undefined){var t=this.names[e.attrs.name];if(t!==undefined){for(var n=0;n<t.length;n++){var r=t[n];r._id===e._id&&t.splice(n,1)}t.length===0&&delete this.names[e.attrs.name]}}},_onContent:function(e,t){var n=e.split(" ");for(var r=0;r<n.length;r++){var i=n[r];this.content.addEventListener(i,t,!1)}},_setStageDefaultProperties:function(){this.nodeType="Stage",this.lastEventTime=0,this.dblClickWindow=400,this.targetShape=undefined,this.targetFound=!1,this.mouseoverShape=undefined,this.mouseoutShape=undefined,this.mousePos=undefined,this.mouseDown=!1,this.mouseUp=!1,this.mouseMove=!1,this.clickStart=!1,this.touchPos=undefined,this.touchStart=!1,this.touchEnd=!1,this.touchMove=!1,this.tapStart=!1,this.ids={},this.names={},this.anim=undefined,this.animRunning=!1}}),Kinetic.Node.addGettersSetters(Kinetic.Stage,["width","height","throttle"]),Kinetic.Layer=Kinetic.Container.extend({init:function(e){this.setDefaultAttrs({throttle:80,clearBeforeDraw:!0}),this.nodeType="Layer",this.lastDrawTime=0,this.beforeDrawFunc=undefined,this.afterDrawFunc=undefined,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this._super(e)},draw:function(){var e=this.attrs.throttle,t=new Date,n=t.getTime(),r=n-this.lastDrawTime,i=1e3/e;if(r>=i||e>200)this._draw(),this.drawTimeout!==undefined&&(clearTimeout(this.drawTimeout),this.drawTimeout=undefined);else if(this.drawTimeout===undefined){var s=this;this.drawTimeout=setTimeout(function(){s.draw()},17)}},beforeDraw:function(e){this.beforeDrawFunc=e},afterDraw:function(e){this.afterDrawFunc=e},clear:function(){var e=this.getContext(),t=this.getCanvas();e.clearRect(0,0,t.width,t.height)},getCanvas:function(){return this.canvas},getContext:function(){return this.context},_draw:function(){var e=new Date,t=e.getTime();this.lastDrawTime=t,this.beforeDrawFunc!==undefined&&this.beforeDrawFunc.call(this),this.attrs.clearBeforeDraw&&this.clear(),this.isVisible()&&(this.attrs.drawFunc!==undefined&&this.attrs.drawFunc.call(this),this._drawChildren()),this.afterDrawFunc!==undefined&&this.afterDrawFunc.call(this)}}),Kinetic.Node.addGettersSetters(Kinetic.Layer,["clearBeforeDraw","throttle"]),Kinetic.Group=Kinetic.Container.extend({init:function(e){this.nodeType="Group",this._super(e)},draw:function(){this.attrs.visible&&this._drawChildren()}}),Kinetic.Shape=Kinetic.Node.extend({init:function(e){this.setDefaultAttrs({detectionType:"path"}),this.data=[],this.nodeType="Shape",this.appliedShadow=!1,this._super(e)},getContext:function(){return this.tempLayer.getContext()},getCanvas:function(){return this.tempLayer.getCanvas()},stroke:function(){var e=Kinetic.Global,t=!1,n=this.getContext();if(this.attrs.stroke||this.attrs.strokeWidth){n.save(),this.attrs.shadow&&!this.appliedShadow&&(t=this._applyShadow());var r=this.attrs.stroke?this.attrs.stroke:"black",i=this.attrs.strokeWidth?this.attrs.strokeWidth:2;n.lineWidth=i,n.strokeStyle=r,n.stroke(),n.restore()}t&&this.stroke()},fill:function(){var e=!1,t=this.getContext();t.save();var n=this.attrs.fill;if(n){this.attrs.shadow&&!this.appliedShadow&&(e=this._applyShadow());var r=n.start,i=n.end,s=null;if(typeof n=="string")s=this.attrs.fill,t.fillStyle=s,t.fill();else if(n.image){var o=n.repeat?n.repeat:"repeat";s=t.createPattern(n.image,o),t.save(),n.scale&&t.scale(n.scale.x,n.scale.y),n.offset&&t.translate(n.offset.x,n.offset.y),t.fillStyle=s,t.fill(),t.restore()}else if(!r.radius&&!i.radius){var t=this.getContext(),u=t.createLinearGradient(r.x,r.y,i.x,i.y),a=n.colorStops;for(var f=0;f<a.length;f+=2)u.addColorStop(a[f],a[f+1]);s=u,t.fillStyle=s,t.fill()}else if(!r.radius&&r.radius!==0||!i.radius&&i.radius!==0)s="black",t.fillStyle=s,t.fill();else{var t=this.getContext(),u=t.createRadialGradient(r.x,r.y,r.radius,i.x,i.y,i.radius),a=n.colorStops;for(var f=0;f<a.length;f+=2)u.addColorStop(a[f],a[f+1]);s=u,t.fillStyle=s,t.fill()}}t.restore(),e&&this.fill()},fillText:function(e){var t=!1,n=this.getContext();n.save(),this.attrs.textFill&&(this.attrs.shadow&&!this.appliedShadow&&(t=this._applyShadow()),n.fillStyle=this.attrs.textFill,n.fillText(e,0,0)),n.restore(),t&&this.fillText(e,0,0)},strokeText:function(e){var t=!1,n=this.getContext();n.save();if(this.attrs.textStroke||this.attrs.textStrokeWidth)this.attrs.shadow&&!this.appliedShadow&&(t=this._applyShadow()),this.attrs.textStroke?!this.attrs.textStrokeWidth&&this.attrs.textStrokeWidth!==0&&(this.attrs.textStrokeWidth=2):this.attrs.textStroke="black",n.lineWidth=this.attrs.textStrokeWidth,n.strokeStyle=this.attrs.textStroke,n.strokeText(e,0,0);n.restore(),t&&this.strokeText(e,0,0)},drawImage:function(){var e=!1,t=this.getContext();t.save();var n=Array.prototype.slice.call(arguments);if(n.length===5||n.length===9){this.attrs.shadow&&!this.appliedShadow&&(e=this._applyShadow());switch(n.length){case 5:t.drawImage(n[0],n[1],n[2],n[3],n[4]);break;case 9:t.drawImage(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}}t.restore(),e&&this.drawImage.apply(this,n)},applyLineJoin:function(){var e=this.getContext();this.attrs.lineJoin&&(e.lineJoin=this.attrs.lineJoin)},_applyShadow:function(){var e=this.getContext(),t=this.attrs.shadow;if(t){var n=this.getAbsoluteAlpha(),r=t.color?t.color:"black",i=t.blur?t.blur:5,s=t.offset?t.offset:{x:0,y:0};return t.alpha&&(e.globalAlpha=t.alpha*n),e.shadowColor=r,e.shadowBlur=i,e.shadowOffsetX=s.x,e.shadowOffsetY=s.y,this.appliedShadow=!0,!0}return!1},saveData:function(){var e=this.getStage(),t=e.attrs.width,n=e.attrs.height,r=e.bufferLayer,i=r.getContext();r.clear(),this._draw(r);var s=i.getImageData(0,0,t,n);this.data=s.data},clearData:function(){this.data=[]},intersects:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=this.getStage();if(this.attrs.detectionType==="path"){var n=t.pathLayer,r=n.getContext();return this._draw(n),r.isPointInPath(e.x,e.y)}var i=t.attrs.width,s=this.data[(i*e.y+e.x)*4+3];return!!s},_draw:function(e){if(e&&this.attrs.drawFunc){var t=e.getStage(),n=e.getContext(),r=[],i=this.parent;r.unshift(this);while(i)r.unshift(i),i=i.parent;n.save();for(var s=0;s<r.length;s++){var o=r[s],u=o.getTransform();(o.attrs.offset.x!==0||o.attrs.offset.y!==0)&&u.translate(-1*o.attrs.offset.x,-1*o.attrs.offset.y);var a=u.getMatrix();n.transform(a[0],a[1],a[2],a[3],a[4],a[5])}this.tempLayer=e;var f=this.getAbsoluteAlpha();f!==1&&(n.globalAlpha=f),this.applyLineJoin(),this.appliedShadow=!1,this.attrs.drawFunc.call(this),n.restore()}}}),Kinetic.Node.addGettersSetters(Kinetic.Shape,["fill","stroke","lineJoin","strokeWidth","shadow","drawFunc"]),Kinetic.Rect=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({width:0,height:0,cornerRadius:0}),this.shapeType="Rect",e.drawFunc=function(){var e=this.getContext();e.beginPath(),this.attrs.cornerRadius===0?e.rect(0,0,this.attrs.width,this.attrs.height):(e.moveTo(this.attrs.cornerRadius,0),e.lineTo(this.attrs.width-this.attrs.cornerRadius,0),e.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),e.lineTo(this.attrs.width,this.attrs.height-this.attrs.cornerRadius),e.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),e.lineTo(this.attrs.cornerRadius,this.attrs.height),e.arc(this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),e.lineTo(0,this.attrs.cornerRadius),e.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),e.closePath(),this.fill(),this.stroke()},this._super(e)},setSize:function(){var e=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(e)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}}}),Kinetic.Node.addGettersSetters(Kinetic.Rect,["width","height","cornerRadius"]),Kinetic.Ellipse=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({radius:{x:0,y:0}}),this.shapeType="Ellipse",e.drawFunc=function(){var e=this.getCanvas(),t=this.getContext(),n=this.getRadius();t.beginPath(),t.save(),n.x!==n.y&&t.scale(1,n.y/n.x),t.arc(0,0,n.x,0,Math.PI*2,!0),t.restore(),t.closePath(),this.fill(),this.stroke()},this._super(e),this._convertRadius();var t=this;this.on("radiusChange.kinetic",function(){t._convertRadius()})},_convertRadius:function(){var e=Kinetic.Type,t=this.getRadius();if(e._isObject(t))return!1;this.attrs.radius=e._getXY(t)}}),Kinetic.Circle=Kinetic.Ellipse,Kinetic.Node.addGettersSetters(Kinetic.Ellipse,["radius"]),Kinetic.Image=Kinetic.Shape.extend({init:function(e){this.shapeType="Image",e.drawFunc=function(){if(!!this.attrs.image){var e=this.attrs.width?this.attrs.width:this.attrs.image.width,t=this.attrs.height?this.attrs.height:this.attrs.image.height,n=this.getCanvas(),r=this.getContext();r.beginPath(),r.rect(0,0,e,t),r.closePath(),this.fill(),this.stroke();if(this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height){var i=this.attrs.crop.x?this.attrs.crop.x:0,s=this.attrs.crop.y?this.attrs.crop.y:0,o=this.attrs.crop.width,u=this.attrs.crop.height;this.drawImage(this.attrs.image,i,s,o,u,0,0,e,t)}else this.drawImage(this.attrs.image,0,0,e,t)}},this._super(e)},setSize:function(){var e=Kinetic.GlobalObject._getSize(Array.prototype.slice.call(arguments));this.setAttrs(e)},getSize:function(){return{width:this.attrs.width,height:this.attrs.height}}}),Kinetic.Node.addGettersSetters(Kinetic.Image,["height","width","image","crop"]),Kinetic.Sprite=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({index:0,frameRate:17}),e.drawFunc=function(){if(!!this.attrs.image){var e=this.getContext(),t=this.attrs.animation,n=this.attrs.index,r=this.attrs.animations[t][n];e.beginPath(),e.rect(0,0,r.width,r.height),e.closePath(),this.drawImage(this.attrs.image,r.x,r.y,r.width,r.height,0,0,r.width,r.height)}},this._super(e);var t=this;this.on("animationChange.kinetic",function(){t.setIndex(0)})},start:function(){var e=this,t=this.getLayer(),n=Kinetic.Animation;this.anim&&(n._removeAnimation(this.anim),this.anim=null),this.anim={node:t},n._addAnimation(this.anim),this.interval=setInterval(function(){var t=e.attrs.index;e._updateIndex(),e.afterFrameFunc&&t===e.afterFrameIndex&&e.afterFrameFunc()},1e3/this.attrs.frameRate),n._handleAnimation()},stop:function(){var e=Kinetic.Animation;this.anim&&(e._removeAnimation(this.anim),this.anim=null),clearInterval(this.interval)},afterFrame:function(e,t){this.afterFrameIndex=e,this.afterFrameFunc=t},_updateIndex:function(){var e=this.attrs.index,t=this.attrs.animation;e<this.attrs.animations[t].length-1?this.attrs.index++:this.attrs.index=0}}),Kinetic.Node.addGettersSetters(Kinetic.Sprite,["animation","animations","index"]),Kinetic.Polygon=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({points:[]}),this.shapeType="Polygon",e.drawFunc=function(){var e=this.getContext();e.beginPath(),e.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var t=1;t<this.attrs.points.length;t++)e.lineTo(this.attrs.points[t].x,this.attrs.points[t].y);e.closePath(),this.fill(),this.stroke()},this._super(e)}}),Kinetic.Node.addGettersSetters(Kinetic.Polygon,["points"]),Kinetic.RegularPolygon=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({radius:0,sides:0}),this.shapeType="RegularPolygon",e.drawFunc=function(){var e=this.getContext();e.beginPath(),e.moveTo(0,0-this.attrs.radius);for(var t=1;t<this.attrs.sides;t++){var n=this.attrs.radius*Math.sin(t*2*Math.PI/this.attrs.sides),r=-1*this.attrs.radius*Math.cos(t*2*Math.PI/this.attrs.sides);e.lineTo(n,r)}e.closePath(),this.fill(),this.stroke()},this._super(e)}}),Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,["radius","sides"]),Kinetic.Star=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0}),this.shapeType="Star",e.drawFunc=function(){var e=this.getContext();e.beginPath(),e.moveTo(0,0-this.attrs.outerRadius);for(var t=1;t<this.attrs.numPoints*2;t++){var n=t%2===0?this.attrs.outerRadius:this.attrs.innerRadius,r=n*Math.sin(t*Math.PI/this.attrs.numPoints),i=-1*n*Math.cos(t*Math.PI/this.attrs.numPoints);e.lineTo(r,i)}e.closePath(),this.fill(),this.stroke()},this._super(e)}}),Kinetic.Node.addGettersSetters(Kinetic.Star,["numPoints","innerRadius","outerRadius"]),Kinetic.Text=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",detectionType:"path",cornerRadius:0,lineHeight:1.2}),this.dummyCanvas=document.createElement("canvas"),this.shapeType="Text",e.drawFunc=function(){var e=this.getContext();e.beginPath();var t=this.getBoxWidth(),n=this.getBoxHeight();this.attrs.cornerRadius===0?e.rect(0,0,t,n):(e.moveTo(this.attrs.cornerRadius,0),e.lineTo(t-this.attrs.cornerRadius,0),e.arc(t-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),e.lineTo(t,n-this.attrs.cornerRadius),e.arc(t-this.attrs.cornerRadius,n-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),e.lineTo(this.attrs.cornerRadius,n),e.arc(this.attrs.cornerRadius,n-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),e.lineTo(0,this.attrs.cornerRadius),e.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),e.closePath(),this.fill(),this.stroke();var r=this.attrs.padding,i=this.attrs.lineHeight*this.getTextHeight(),s=this.textArr;e.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,e.textBaseline="middle",e.textAlign="left",e.save(),e.translate(r,0),e.translate(0,r+this.getTextHeight()/2);for(var o=0;o<s.length;o++){var u=s[o];e.save(),this.attrs.align==="right"?e.translate(this.getBoxWidth()-this._getTextSize(u).width-r*2,0):this.attrs.align==="center"&&e.translate((this.getBoxWidth()-this._getTextSize(u).width-r*2)/2,0),this.fillText(u),this.strokeText(u),e.restore(),e.translate(0,i)}e.restore()},this._super(e);var t=["width","height","padding","text","textStroke","textStrokeWidth"],n=this;for(var r=0;r<t.length;r++){var i=t[r];this.on(i+"Change.kinetic",n._setTextData)}n._setTextData()},getBoxWidth:function(){return this.attrs.width==="auto"?this.getTextWidth()+this.attrs.padding*2:this.attrs.width},getBoxHeight:function(){return this.attrs.height==="auto"?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+this.attrs.padding*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(e){var t=this.dummyCanvas,n=t.getContext("2d");n.save(),n.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var r=n.measureText(e);return n.restore(),{width:r.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var e=this.attrs.text.split(""),t=[],n=0,r=!0;this.textWidth=0,this.textHeight=this._getTextSize(this.attrs.text).height;var i=this.attrs.lineHeight*this.textHeight;while(e.length>0&&r&&(this.attrs.height==="auto"||i*(n+1)<this.attrs.height-this.attrs.padding*2)){var s=0,o=undefined;r=!1;while(s<e.length){if(e.indexOf("\n")===s){e.splice(s,1),o=e.splice(0,s).join("");break}var u=e.slice(0,s);if(this.attrs.width!=="auto"&&this._getTextSize(u.join("")).width>this.attrs.width-this.attrs.padding*2){if(s==0)break;var a=u.lastIndexOf(" "),f=u.lastIndexOf("-"),l=Math.max(a,f);if(l>=0){o=e.splice(0,1+l).join("");break}o=e.splice(0,s).join("");break}s++,s===e.length&&(o=e.splice(0,s).join(""))}this.textWidth=Math.max(this.textWidth,this._getTextSize(o).width),o!==undefined&&(t.push(o),r=!0),n++}this.textArr=t}}),Kinetic.Node.addGettersSetters(Kinetic.Text,["fontFamily","fontSize","fontStyle","textFill","textStroke","textStrokeWidth","padding","align","lineHeight","text","width","height","cornerRadius","fill","stroke","strokeWidth","shadow"]),Kinetic.Line=Kinetic.Shape.extend({init:function(e){this.setDefaultAttrs({points:[],lineCap:"butt",dashArray:[],detectionType:"pixel"}),this.shapeType="Line",e.drawFunc=function(){var e=this.getContext(),t={};e.beginPath(),e.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++){var r=this.attrs.points[n].x,i=this.attrs.points[n].y;if(this.attrs.dashArray.length>0){var s=this.attrs.points[n-1].x,o=this.attrs.points[n-1].y;this._dashedLine(s,o,r,i,this.attrs.dashArray)}else e.lineTo(r,i)}!this.attrs.lineCap||(e.lineCap=this.attrs.lineCap),this.stroke()},this._super(e)},_dashedLine:function(e,t,n,r,i){var s=this.getContext(),o=i.length,u=n-e,a=r-t,f=u>a,l=f?a/u:u/a;l>9999?l=9999:l<-9999&&(l=-9999);var c=Math.sqrt(u*u+a*a),h=0,p=!0;while(c>=.1&&h<1e4){var d=i[h++%o];d===0&&(d=.001),d>c&&(d=c);var v=Math.sqrt(d*d/(1+l*l));f?(e+=u<0&&a<0?v*-1:v,t+=u<0&&a<0?l*v*-1:l*v):(e+=u<0&&a<0?l*v*-1:l*v,t+=u<0&&a<0?v*-1:v),s[p?"lineTo":"moveTo"](e,t),c-=d,p=!p}s.moveTo(n,r)}}),Kinetic.Node.addGettersSetters(Kinetic.Line,["dashArray","lineCap","points"]),Kinetic.Path=Kinetic.Shape.extend({init:function(e){this.shapeType="Path",this.dataArray=[];var t=this;e.drawFunc=function(){var e=this.getContext(),t=this.dataArray;e.beginPath();for(var n=0;n<t.length;n++){var r=t[n].command,i=t[n].points;switch(r){case"L":e.lineTo(i[0],i[1]);break;case"M":e.moveTo(i[0],i[1]);break;case"C":e.bezierCurveTo(i[0],i[1],i[2],i[3],i[4],i[5]);break;case"Q":e.quadraticCurveTo(i[0],i[1],i[2],i[3]);break;case"A":var s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5],c=i[6],h=i[7],p=u>a?u:a,d=u>a?1:u/a,v=u>a?a/u:1;e.translate(s,o),e.rotate(c),e.scale(d,v),e.arc(0,0,p,f,f+l,1-h),e.scale(1/d,1/v),e.rotate(-c),e.translate(-s,-o);break;case"z":e.closePath()}}this.fill(),this.stroke()},this._super(e),this.dataArray=this._getDataArray(),this.on("dataChange",function(){t.dataArray=t._getDataArray()})},_getDataArray:function(){var e=this.attrs.data;if(!this.attrs.data)return[];var t=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];e=e.replace(new RegExp(" ","g"),",");for(var n=0;n<t.length;n++)e=e.replace(new RegExp(t[n],"g"),"|"+t[n]);var r=e.split("|"),i=[],s=0,o=0;for(var n=1;n<r.length;n++){var u=r[n],a=u.charAt(0);u=u.slice(1),u=u.replace(new RegExp(",-","g"),"-"),u=u.replace(new RegExp("-","g"),",-");var f=u.split(",");f.length>0&&f[0]===""&&f.shift();for(var l=0;l<f.length;l++)f[l]=parseFloat(f[l]);while(f.length>0){if(isNaN(f[0]))break;var c=undefined,h=[];switch(a){case"l":s+=f.shift(),o+=f.shift(),c="L",h.push(s,o);break;case"L":s=f.shift(),o=f.shift(),h.push(s,o);break;case"m":s+=f.shift(),o+=f.shift(),c="M",h.push(s,o),a="l";break;case"M":s=f.shift(),o=f.shift(),c="M",h.push(s,o),a="L";break;case"h":s+=f.shift(),c="L",h.push(s,o);break;case"H":s=f.shift(),c="L",h.push(s,o);break;case"v":o+=f.shift(),c="L",h.push(s,o);break;case"V":o=f.shift(),c="L",h.push(s,o);break;case"C":h.push(f.shift(),f.shift(),f.shift(),f.shift()),s=f.shift(),o=f.shift(),h.push(s,o);break;case"c":h.push(s+f.shift(),o+f.shift(),s+f.shift(),o+f.shift()),s+=f.shift(),o+=f.shift(),c="C",h.push(s,o);break;case"S":var p=s,d=o,v=i[i.length-1];v.command==="C"&&(p=s+(s-v.points[2]),d=o+(o-v.points[3])),h.push(p,d,f.shift(),f.shift()),s=f.shift(),o=f.shift(),c="C",h.push(s,o);break;case"s":var p=s,d=o,v=i[i.length-1];v.command==="C"&&(p=s+(s-v.points[2]),d=o+(o-v.points[3])),h.push(p,d,s+f.shift(),o+f.shift()),s+=f.shift(),o+=f.shift(),c="C",h.push(s,o);break;case"Q":h.push(f.shift(),f.shift()),s=f.shift(),o=f.shift(),h.push(s,o);break;case"q":h.push(s+f.shift(),o+f.shift()),s+=f.shift(),o+=f.shift(),c="Q",h.push(s,o);break;case"T":var p=s,d=o,v=i[i.length-1];v.command==="Q"&&(p=s+(s-v.points[0]),d=o+(o-v.points[1])),s=f.shift(),o=f.shift(),c="Q",h.push(p,d,s,o);break;case"t":var p=s,d=o,v=i[i.length-1];v.command==="Q"&&(p=s+(s-v.points[0]),d=o+(o-v.points[1])),s+=f.shift(),o+=f.shift(),c="Q",h.push(p,d,s,o);break;case"A":var m=f.shift(),g=f.shift(),y=f.shift(),b=f.shift(),w=f.shift(),E=s,S=o;s=f.shift(),o=f.shift(),c="A",h=this._convertEndpointToCenterParameterization(E,S,s,o,b,w,m,g,y);break;case"a":var m=f.shift(),g=f.shift(),y=f.shift(),b=f.shift(),w=f.shift(),E=s,S=o;s+=f.shift(),o+=f.shift(),c="A",h=this._convertEndpointToCenterParameterization(E,S,s,o,b,w,m,g,y)}i.push({command:c||a,points:h})}(a==="z"||a==="Z")&&i.push({command:"z",points:[]})}return i},_convertEndpointToCenterParameterization:function(e,t,n,r,i,s,o,u,a){var f=a*(Math.PI/180),l=Math.cos(f)*(e-n)/2+Math.sin(f)*(t-r)/2,c=-1*Math.sin(f)*(e-n)/2+Math.cos(f)*(t-r)/2,h=l*l/(o*o)+c*c/(u*u);h>1&&(o*=Math.sqrt(h),u*=Math.sqrt(h));var p=Math.sqrt((o*o*u*u-o*o*c*c-u*u*l*l)/(o*o*c*c+u*u*l*l));i==s&&(p*=-1),isNaN(p)&&(p=0);var d=p*o*c/u,v=p*-u*l/o,m=(e+n)/2+Math.cos(f)*d-Math.sin(f)*v,g=(t+r)/2+Math.sin(f)*d+Math.cos(f)*v,y=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},b=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(y(e)*y(t))},w=function(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(b(e,t))},E=w([1,0],[(l-d)/o,(c-v)/u]),S=[(l-d)/o,(c-v)/u],x=[(-1*l-d)/o,(-1*c-v)/u],T=w(S,x);return b(S,x)<=-1&&(T=Math.PI),b(S,x)>=1&&(T=0),s==0&&T>0&&(T-=2*Math.PI),s==1&&T<0&&(T+=2*Math.PI),[m,g,o,u,E,T,f,s]}}),Kinetic.Node.addGettersSetters(Kinetic.Path,["data"]),Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]},Kinetic.Transform.prototype={translate:function(e,t){this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t},scale:function(e,t){this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=this.m[0]*t+this.m[2]*n,i=this.m[1]*t+this.m[3]*n,s=this.m[0]*-n+this.m[2]*t,o=this.m[1]*-n+this.m[3]*t;this.m[0]=r,this.m[1]=i,this.m[2]=s,this.m[3]=o},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(e){var t=this.m[0]*e.m[0]+this.m[2]*e.m[1],n=this.m[1]*e.m[0]+this.m[3]*e.m[1],r=this.m[0]*e.m[2]+this.m[2]*e.m[3],i=this.m[1]*e.m[2]+this.m[3]*e.m[3],s=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],o=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];this.m[0]=t,this.m[1]=n,this.m[2]=r,this.m[3]=i,this.m[4]=s,this.m[5]=o},invert:function(){var e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,n=-this.m[1]*e,r=-this.m[2]*e,i=this.m[0]*e,s=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),o=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=t,this.m[1]=n,this.m[2]=r,this.m[3]=i,this.m[4]=s,this.m[5]=o},getMatrix:function(){return this.m}},Kinetic.Transition=function(e,t){function n(e,t,i,s){for(var o in e)o!=="duration"&&o!=="easing"&&o!=="callback"&&(Kinetic.Type._isObject(e[o])?(i[o]={},n(e[o],t[o],i[o],s)):r._add(r._getTween(t,o,e[o],i,s)))}this.node=e,this.config=t,this.tweens=[];var r=this,i={};n(t,e.attrs,i,i);var s=0;for(var o=0;o<this.tweens.length;o++){var u=this.tweens[o];u.onFinished=function(){s++,s>=r.tweens.length&&r.onFinished()}}},Kinetic.Transition.prototype={start:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].start()},stop:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].stop()},resume:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].resume()},_onEnterFrame:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].onEnterFrame()},_add:function(e){this.tweens.push(e)},_getTween:function(e,t,n,r,i){var s=this.config,o=this.node,u=s.easing;u===undefined&&(u="linear");var a=new Kinetic.Tween(o,function(e){r[t]=e,o.setAttrs(i)},Kinetic.Tweens[u],e[t],n,s.duration);return a}},Kinetic.Tween=function(e,t,n,r,i,s){this._listeners=[],this.addListener(this),this.obj=e,this.propFunc=t,this.begin=r,this._pos=r,this.setDuration(s),this.isPlaying=!1,this._change=0,this.prevTime=0,this.prevPos=0,this.looping=!1,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.name="",this.func=n,this.setFinish(i)},Kinetic.Tween.prototype={setTime:function(e){this.prevTime=this._time,e>this.getDuration()?this.looping?(this.rewind(e-this._duration),this.update(),this.broadcastMessage("onLooped",{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):e<0?(this.rewind(),this.update()):(this._time=e,this.update())},getTime:function(){return this._time},setDuration:function(e){this._duration=e===null||e<=0?1e5:e},getDuration:function(){return this._duration},setPosition:function(e){this.prevPos=this._pos,this.propFunc(e),this._pos=e,this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(e){return e===undefined&&(e=this._time),this.func(e,this.begin,this._change,this._duration)},setFinish:function(e){this._change=e-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind(),this.startEnterFrame(),this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(e){this.stop(),this._time=e===undefined?0:e,this.fixTime(),this.update()},fforward:function(){this._time=this._duration,this.fixTime(),this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame(),this.isPlaying=!0,this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1e3)},stop:function(){this.stopEnterFrame(),this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(e,t){this.begin=this._pos,this.setFinish(e),this._duration!==undefined&&this.setDuration(t),this.start()},resume:function(){this.fixTime(),this.startEnterFrame(),this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(e){return this.removeListener(e),this._listeners.push(e)},removeListener:function(e){var t=this._listeners,n=t.length;while(n--)if(t[n]==e)return t.splice(n,1),!0;return!1},broadcastMessage:function(){var e=[];for(var t=0;t<arguments.length;t++)e.push(arguments[t]);var n=e.shift(),r=this._listeners,i=r.length;for(var t=0;t<i;t++)r[t][n]&&r[t][n].apply(r[t],e)},fixTime:function(){this._startTime=this.getTimer()-this._time*1e3},getTimer:function(){return(new Date).getTime()-this._time}},Kinetic.Tweens={"back-ease-in":function(e,t,n,r,i,s){var o=1.70158;return n*(e/=r)*e*((o+1)*e-o)+t},"back-ease-out":function(e,t,n,r,i,s){var o=1.70158;return n*((e=e/r-1)*e*((o+1)*e+o)+1)+t},"back-ease-in-out":function(e,t,n,r,i,s){var o=1.70158;return(e/=r/2)<1?n/2*e*e*(((o*=1.525)+1)*e-o)+t:n/2*((e-=2)*e*(((o*=1.525)+1)*e+o)+2)+t},"elastic-ease-in":function(e,t,n,r,i,s){var o=0;return e===0?t:(e/=r)==1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t)},"elastic-ease-out":function(e,t,n,r,i,s){var o=0;return e===0?t:(e/=r)==1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t)},"elastic-ease-in-out":function(e,t,n,r,i,s){var o=0;return e===0?t:(e/=r/2)==2?t+n:(s||(s=r*.3*1.5),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t)},"bounce-ease-out":function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},"bounce-ease-in":function(e,t,n,r){return n-Kinetic.Tweens["bounce-ease-out"](r-e,0,n,r)+t},"bounce-ease-in-out":function(e,t,n,r){return e<r/2?Kinetic.Tweens["bounce-ease-in"](e*2,0,n,r)*.5+t:Kinetic.Tweens["bounce-ease-out"](e*2-r,0,n,r)*.5+n*.5+t},"ease-in":function(e,t,n,r){return n*(e/=r)*e+t},"ease-out":function(e,t,n,r){return-n*(e/=r)*(e-2)+t},"ease-in-out":function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},"strong-ease-in":function(e,t,n,r){return n*(e/=r)*e*e*e*e+t},"strong-ease-out":function(e,t,n,r){return n*((e=e/r-1)*e*e*e*e+1)+t},"strong-ease-in-out":function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},linear:function(e,t,n,r){return n*e/r+t}},define("kinetic",function(){}),function(){define("ResizeCommand",["kinetic"],function(e){var t;return t=function(){function e(){}return e.action=function(e){var t,n,r,i,s,o,u,a,f=this;return console.log("making image resizable"),r=e.group,a=e.corners,o=a.tl,u=a.tr,t=a.bl,n=a.br,i=e.item,s=i.getPosition(),o.on("dragmove",function(){var e,n;return u.attrs.y=o.attrs.y,t.attrs.x=o.attrs.x,n=u.attrs.x-o.attrs.x,e=t.attrs.y-o.attrs.y,i.setPosition(o.attrs.x+6,o.attrs.y+6),i.setSize(n,e)}),t.on("dragmove",function(){var e,r;return o.attrs.x=t.attrs.x,n.attrs.y=t.attrs.y,r=u.attrs.x-o.attrs.x,e=t.attrs.y-o.attrs.y,i.setPosition(o.attrs.x+6,o.attrs.y+6),i.setSize(r,e)}),u.on("dragmove",function(){var e,r;return o.attrs.y=u.attrs.y,n.attrs.x=u.attrs.x,r=u.attrs.x-o.attrs.x,e=t.attrs.y-o.attrs.y,i.setPosition(o.attrs.x+6,o.attrs.y+6),i.setSize(r,e)}),n.on("dragmove",function(){var e,r;return t.attrs.y=n.attrs.y,u.attrs.x=n.attrs.x,r=u.attrs.x-o.attrs.x,e=t.attrs.y-o.attrs.y,i.setPosition(o.attrs.x+6,o.attrs.y+6),i.setSize(r,e)}),_.each([o,u,n,t],function(e){var t=this;return e.show(),e.on("mousedown",function(){return console.log("tl mousedown"),r.setDraggable(!1),r.moveToTop()}),e.on("dragend",function(){return r.setDraggable(!0)})}),i.getLayer().draw()},e}()})}.call(this),function(){function e(t,n,r){if(t===n)return 0!==t||1/t==1/n;if(null==t||null==n)return t===n;t._chain&&(t=t._wrapped),n._chain&&(n=n._wrapped);if(t.isEqual&&E.isFunction(t.isEqual))return t.isEqual(n);if(n.isEqual&&E.isFunction(n.isEqual))return n.isEqual(t);var i=a.call(t);if(i!=a.call(n))return!1;switch(i){case"[object String]":return t==""+n;case"[object Number]":return t!=+t?n!=+n:0==t?1/t==1/n:t==+n;case"[object Date]":case"[object Boolean]":return+t==+n;case"[object RegExp]":return t.source==n.source&&t.global==n.global&&t.multiline==n.multiline&&t.ignoreCase==n.ignoreCase}if("object"!=typeof t||"object"!=typeof n)return!1;for(var s=r.length;s--;)if(r[s]==t)return!0;r.push(t);var s=0,o=!0;if("[object Array]"==i){if(s=t.length,o=s==n.length)for(;s--&&(o=s in t==s in n&&e(t[s],n[s],r)););}else{if("constructor"in t!="constructor"in n||t.constructor!=n.constructor)return!1;for(var u in t)if(E.has(t,u)&&(s++,!(o=E.has(n,u)&&e(t[u],n[u],r))))break;if(o){for(u in n)if(E.has(n,u)&&!(s--))break;o=!s}}return r.pop(),o}var t=this,n=t._,r={},i=Array.prototype,s=Object.prototype,o=i.slice,u=i.unshift,a=s.toString,f=s.hasOwnProperty,l=i.forEach,c=i.map,h=i.reduce,p=i.reduceRight,d=i.filter,v=i.every,m=i.some,g=i.indexOf,y=i.lastIndexOf,s=Array.isArray,b=Object.keys,w=Function.prototype.bind,E=function(e){return new _(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=E),exports._=E):t._=E,E.VERSION="1.3.3";var S=E.each=E.forEach=function(e,t,n){if(e!=null)if(l&&e.forEach===l)e.forEach(t,n);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(n,e[i],i,e)===r)break}else for(i in e)if(E.has(e,i)&&t.call(n,e[i],i,e)===r)break};E.map=E.collect=function(e,t,n){var r=[];return e==null?r:c&&e.map===c?e.map(t,n):(S(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),e.length===+e.length&&(r.length=e.length),r)},E.reduce=E.foldl=E.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(h&&e.reduce===h)return r&&(t=E.bind(t,r)),i?e.reduce(t,n):e.reduce(t);S(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},E.reduceRight=E.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduceRight===p)return r&&(t=E.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=E.toArray(e).reverse();return r&&!i&&(t=E.bind(t,r)),i?E.reduce(s,t,n,r):E.reduce(s,t)},E.find=E.detect=function(e,t,n){var r;return x(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},E.filter=E.select=function(e,t,n){var r=[];return e==null?r:d&&e.filter===d?e.filter(t,n):(S(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},E.reject=function(e,t,n){var r=[];return e==null?r:(S(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},E.every=E.all=function(e,t,n){var i=!0;return e==null?i:v&&e.every===v?e.every(t,n):(S(e,function(e,s,o){if(!(i=i&&t.call(n,e,s,o)))return r}),!!i)};var x=E.some=E.any=function(e,t,n){t||(t=E.identity);var i=!1;return e==null?i:m&&e.some===m?e.some(t,n):(S(e,function(e,s,o){if(i||(i=t.call(n,e,s,o)))return r}),!!i)};E.include=E.contains=function(e,t){var n=!1;return e==null?n:g&&e.indexOf===g?e.indexOf(t)!=-1:n=x(e,function(e){return e===t})},E.invoke=function(e,t){var n=o.call(arguments,2);return E.map(e,function(e){return(E.isFunction(t)?t||e:e[t]).apply(e,n)})},E.pluck=function(e,t){return E.map(e,function(e){return e[t]})},E.max=function(e,t,n){if(!t&&E.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&E.isEmpty(e))return-Infinity;var r={computed:-Infinity};return S(e,function(e,i,s){i=t?t.call(n,e,i,s):e,i>=r.computed&&(r={value:e,computed:i})}),r.value},E.min=function(e,t,n){if(!t&&E.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&E.isEmpty(e))return Infinity;var r={computed:Infinity};return S(e,function(e,i,s){i=t?t.call(n,e,i,s):e,i<r.computed&&(r={value:e,computed:i})}),r.value},E.shuffle=function(e){var t=[],n;return S(e,function(e,r){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},E.sortBy=function(e,t,n){var r=E.isFunction(t)?t:function(e){return e[t]};return E.pluck(E.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},E.groupBy=function(e,t){var n={},r=E.isFunction(t)?t:function(e){return e[t]};return S(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},E.sortedIndex=function(e,t,n){n||(n=E.identity);for(var r=0,i=e.length;r<i;){var s=r+i>>1;n(e[s])<n(t)?r=s+1:i=s}return r},E.toArray=function(e){return e?E.isArray(e)||E.isArguments(e)?o.call(e):e.toArray&&E.isFunction(e.toArray)?e.toArray():E.values(e):[]},E.size=function(e){return E.isArray(e)?e.length:E.keys(e).length},E.first=E.head=E.take=function(e,t,n){return t!=null&&!n?o.call(e,0,t):e[0]},E.initial=function(e,t,n){return o.call(e,0,e.length-(t==null||n?1:t))},E.last=function(e,t,n){return t!=null&&!n?o.call(e,Math.max(e.length-t,0)):e[e.length-1]},E.rest=E.tail=function(e,t,n){return o.call(e,t==null||n?1:t)},E.compact=function(e){return E.filter(e,function(e){return!!e})},E.flatten=function(e,t){return E.reduce(e,function(e,n){return E.isArray(n)?e.concat(t?n:E.flatten(n)):(e[e.length]=n,e)},[])},E.without=function(e){return E.difference(e,o.call(arguments,1))},E.uniq=E.unique=function(e,t,n){var n=n?E.map(e,n):e,r=[];return e.length<3&&(t=!0),E.reduce(n,function(n,i,s){if(t?E.last(n)!==i||!n.length:!E.include(n,i))n.push(i),r.push(e[s]);return n},[]),r},E.union=function(){return E.uniq(E.flatten(arguments,!0))},E.intersection=E.intersect=function(e){var t=o.call(arguments,1);return E.filter(E.uniq(e),function(e){return E.every(t,function(t){return E.indexOf(t,e)>=0})})},E.difference=function(e){var t=E.flatten(o.call(arguments,1),!0);return E.filter(e,function(e){return!E.include(t,e)})},E.zip=function(){for(var e=o.call(arguments),t=E.max(E.pluck(e,"length")),n=Array(t),r=0;r<t;r++)n[r]=E.pluck(e,""+r);return n},E.indexOf=function(e,t,n){if(e==null)return-1;var r;if(n)return n=E.sortedIndex(e,t),e[n]===t?n:-1;if(g&&e.indexOf===g)return e.indexOf(t);n=0;for(r=e.length;n<r;n++)if(n in e&&e[n]===t)return n;return-1},E.lastIndexOf=function(e,t){if(e==null)return-1;if(y&&e.lastIndexOf===y)return e.lastIndexOf(t);for(var n=e.length;n--;)if(n in e&&e[n]===t)return n;return-1},E.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0);for(var n=arguments[2]||1,r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);i<r;)s[i++]=e,e+=n;return s};var T=function(){};E.bind=function(e,t){var n,r;if(e.bind===w&&w)return w.apply(e,o.call(arguments,1));if(!E.isFunction(e))throw new TypeError;return r=o.call(arguments,2),n=function(){if(this instanceof n){T.prototype=e.prototype;var i=new T,s=e.apply(i,r.concat(o.call(arguments)));return Object(s)===s?s:i}return e.apply(t,r.concat(o.call(arguments)))}},E.bindAll=function(e){var t=o.call(arguments,1);return t.length==0&&(t=E.functions(e)),S(t,function(t){e[t]=E.bind(e[t],e)}),e},E.memoize=function(e,t){var n={};return t||(t=E.identity),function(){var r=t.apply(this,arguments);return E.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},E.delay=function(e,t){var n=o.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},E.defer=function(e){return E.delay.apply(E,[e,1].concat(o.call(arguments,1)))},E.throttle=function(e,t){var n,r,i,s,o,u,a=E.debounce(function(){o=s=!1},t);return function(){return n=this,r=arguments,i||(i=setTimeout(function(){i=null,o&&e.apply(n,r),a()},t)),s?o=!0:u=e.apply(n,r),a(),s=!0,u}},E.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments;n&&!r&&e.apply(i,s),clearTimeout(r),r=setTimeout(function(){r=null,n||e.apply(i,s)},t)}},E.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},E.wrap=function(e,t){return function(){var n=[e].concat(o.call(arguments,0));return t.apply(this,n)}},E.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},E.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},E.keys=b||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[],n;for(n in e)E.has(e,n)&&(t[t.length]=n);return t},E.values=function(e){return E.map(e,E.identity)},E.functions=E.methods=function(e){var t=[],n;for(n in e)E.isFunction(e[n])&&t.push(n);return t.sort()},E.extend=function(e){return S(o.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},E.pick=function(e){var t={};return S(E.flatten(o.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},E.defaults=function(e){return S(o.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},E.clone=function(e){return E.isObject(e)?E.isArray(e)?e.slice():E.extend({},e):e},E.tap=function(e,t){return t(e),e},E.isEqual=function(t,n){return e(t,n,[])},E.isEmpty=function(e){if(e==null)return!0;if(E.isArray(e)||E.isString(e))return e.length===0;for(var t in e)if(E.has(e,t))return!1;return!0},E.isElement=function(e){return!!e&&e.nodeType==1},E.isArray=s||function(e){return a.call(e)=="[object Array]"},E.isObject=function(e){return e===Object(e)},E.isArguments=function(e){return a.call(e)=="[object Arguments]"},E.isArguments(arguments)||(E.isArguments=function(e){return!!e&&!!E.has(e,"callee")}),E.isFunction=function(e){return a.call(e)=="[object Function]"},E.isString=function(e){return a.call(e)=="[object String]"},E.isNumber=function(e){return a.call(e)=="[object Number]"},E.isFinite=function(e){return E.isNumber(e)&&isFinite(e)},E.isNaN=function(e){return e!==e},E.isBoolean=function(e){return e===!0||e===!1||a.call(e)=="[object Boolean]"},E.isDate=function(e){return a.call(e)=="[object Date]"},E.isRegExp=function(e){return a.call(e)=="[object RegExp]"},E.isNull=function(e){return e===null},E.isUndefined=function(e){return e===void 0},E.has=function(e,t){return f.call(e,t)},E.noConflict=function(){return t._=n,this},E.identity=function(e){return e},E.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},E.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},E.result=function(e,t){if(e==null)return null;var n=e[t];return E.isFunction(n)?n.call(e):n},E.mixin=function(e){S(E.functions(e),function(t){P(t,E[t]=e[t])})};var N=0;E.uniqueId=function(e){var t=N++;return e?e+t:t},E.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/.^/,k={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"},L;for(L in k)k[k[L]]=L;var A=/\\|'|\r|\n|\t|\u2028|\u2029/g,O=/\\(\\|'|r|n|t|u2028|u2029)/g,M=function(e){return e.replace(O,function(e,t){return k[t]})};E.template=function(e,t,n){n=E.defaults(n||{},E.templateSettings),e="__p+='"+e.replace(A,function(e){return"\\"+k[e]}).replace(n.escape||C,function(e,t){return"'+\n_.escape("+M(t)+")+\n'"}).replace(n.interpolate||C,function(e,t){return"'+\n("+M(t)+")+\n'"}).replace(n.evaluate||C,function(e,t){return"';\n"+M(t)+"\n;__p+='"})+"';\n",n.variable||(e="with(obj||{}){\n"+e+"}\n");var e="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+e+"return __p;\n",r=new Function(n.variable||"obj","_",e);return t?r(t,E):(t=function(e){return r.call(this,e,E)},t.source="function("+(n.variable||"obj")+"){\n"+e+"}",t)},E.chain=function(e){return E(e).chain()};var _=function(e){this._wrapped=e};E.prototype=_.prototype;var D=function(e,t){return t?E(e).chain():e},P=function(e,t){_.prototype[e]=function(){var e=o.call(arguments);return u.call(e,this._wrapped),D(t.apply(E,e),this._chain)}};E.mixin(E),S("pop,push,reverse,shift,sort,splice,unshift".split(","),function(e){var t=i[e];_.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);var r=n.length;return(e=="shift"||e=="splice")&&r===0&&delete n[0],D(n,this._chain)}}),S(["concat","join","slice"],function(e){var t=i[e];_.prototype[e]=function(){return D(t.apply(this._wrapped,arguments),this._chain)}}),_.prototype.chain=function(){return this._chain=!0,this},_.prototype.value=function(){return this._wrapped}}.call(this),define("underscore",function(){}),eval(function(e,t,n,r,i,s){i=function(e){return(e<t?"":i(parseInt(e/t)))+((e%=t)>35?String.fromCharCode(e+29):e.toString(36))};if(!"".replace(/^/,String)){while(n--)s[i(n)]=r[n]||i(n);r=[function(e){return s[e]}],i=function(){return"\\w+"},n=1}while(n--)r[n]&&(e=e.replace(new RegExp("\\b"+i(n)+"\\b","g"),r[n]));return e}("9 17={3i:'0.1.3',16:1e-6};l v(){}v.23={e:l(i){8(i<1||i>7.4.q)?w:7.4[i-1]},2R:l(){8 7.4.q},1u:l(){8 F.1x(7.2u(7))},24:l(a){9 n=7.4.q;9 V=a.4||a;o(n!=V.q){8 1L}J{o(F.13(7.4[n-1]-V[n-1])>17.16){8 1L}}H(--n);8 2x},1q:l(){8 v.u(7.4)},1b:l(a){9 b=[];7.28(l(x,i){b.19(a(x,i))});8 v.u(b)},28:l(a){9 n=7.4.q,k=n,i;J{i=k-n;a(7.4[i],i+1)}H(--n)},2q:l(){9 r=7.1u();o(r===0){8 7.1q()}8 7.1b(l(x){8 x/r})},1C:l(a){9 V=a.4||a;9 n=7.4.q,k=n,i;o(n!=V.q){8 w}9 b=0,1D=0,1F=0;7.28(l(x,i){b+=x*V[i-1];1D+=x*x;1F+=V[i-1]*V[i-1]});1D=F.1x(1D);1F=F.1x(1F);o(1D*1F===0){8 w}9 c=b/(1D*1F);o(c<-1){c=-1}o(c>1){c=1}8 F.37(c)},1m:l(a){9 b=7.1C(a);8(b===w)?w:(b<=17.16)},34:l(a){9 b=7.1C(a);8(b===w)?w:(F.13(b-F.1A)<=17.16)},2k:l(a){9 b=7.2u(a);8(b===w)?w:(F.13(b)<=17.16)},2j:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x+V[i-1]})},2C:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x-V[i-1]})},22:l(k){8 7.1b(l(x){8 x*k})},x:l(k){8 7.22(k)},2u:l(a){9 V=a.4||a;9 i,2g=0,n=7.4.q;o(n!=V.q){8 w}J{2g+=7.4[n-1]*V[n-1]}H(--n);8 2g},2f:l(a){9 B=a.4||a;o(7.4.q!=3||B.q!=3){8 w}9 A=7.4;8 v.u([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])])},2A:l(){9 m=0,n=7.4.q,k=n,i;J{i=k-n;o(F.13(7.4[i])>F.13(m)){m=7.4[i]}}H(--n);8 m},2Z:l(x){9 a=w,n=7.4.q,k=n,i;J{i=k-n;o(a===w&&7.4[i]==x){a=i+1}}H(--n);8 a},3g:l(){8 S.2X(7.4)},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(y){8(F.13(y-x)<=17.16)?x:y})},1o:l(a){o(a.K){8 a.1o(7)}9 V=a.4||a;o(V.q!=7.4.q){8 w}9 b=0,2b;7.28(l(x,i){2b=x-V[i-1];b+=2b*2b});8 F.1x(b)},3a:l(a){8 a.1h(7)},2T:l(a){8 a.1h(7)},1V:l(t,a){9 V,R,x,y,z;2S(7.4.q){27 2:V=a.4||a;o(V.q!=2){8 w}R=S.1R(t).4;x=7.4[0]-V[0];y=7.4[1]-V[1];8 v.u([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);1I;27 3:o(!a.U){8 w}9 C=a.1r(7).4;R=S.1R(t,a.U).4;x=7.4[0]-C[0];y=7.4[1]-C[1];z=7.4[2]-C[2];8 v.u([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);1I;2P:8 w}},1t:l(a){o(a.K){9 P=7.4.2O();9 C=a.1r(P).4;8 v.u([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))])}1d{9 Q=a.4||a;o(7.4.q!=Q.q){8 w}8 7.1b(l(x,i){8 Q[i-1]+(Q[i-1]-x)})}},1N:l(){9 V=7.1q();2S(V.4.q){27 3:1I;27 2:V.4.19(0);1I;2P:8 w}8 V},2n:l(){8'['+7.4.2K(', ')+']'},26:l(a){7.4=(a.4||a).2O();8 7}};v.u=l(a){9 V=25 v();8 V.26(a)};v.i=v.u([1,0,0]);v.j=v.u([0,1,0]);v.k=v.u([0,0,1]);v.2J=l(n){9 a=[];J{a.19(F.2F())}H(--n);8 v.u(a)};v.1j=l(n){9 a=[];J{a.19(0)}H(--n);8 v.u(a)};l S(){}S.23={e:l(i,j){o(i<1||i>7.4.q||j<1||j>7.4[0].q){8 w}8 7.4[i-1][j-1]},33:l(i){o(i>7.4.q){8 w}8 v.u(7.4[i-1])},2E:l(j){o(j>7.4[0].q){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][j-1])}H(--n);8 v.u(a)},2R:l(){8{2D:7.4.q,1p:7.4[0].q}},2D:l(){8 7.4.q},1p:l(){8 7.4[0].q},24:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(7.4.q!=M.q||7.4[0].q!=M[0].q){8 1L}9 b=7.4.q,15=b,i,G,10=7.4[0].q,j;J{i=15-b;G=10;J{j=10-G;o(F.13(7.4[i][j]-M[i][j])>17.16){8 1L}}H(--G)}H(--b);8 2x},1q:l(){8 S.u(7.4)},1b:l(a){9 b=[],12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;b[i]=[];J{j=10-G;b[i][j]=a(7.4[i][j],i+1,j+1)}H(--G)}H(--12);8 S.u(b)},2i:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4.q==M.q&&7.4[0].q==M[0].q)},2j:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x+M[i-1][j-1]})},2C:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x-M[i-1][j-1]})},2B:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4[0].q==M.q)},22:l(a){o(!a.4){8 7.1b(l(x){8 x*a})}9 b=a.1u?2x:1L;9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2B(M)){8 w}9 d=7.4.q,15=d,i,G,10=M[0].q,j;9 e=7.4[0].q,4=[],21,20,c;J{i=15-d;4[i]=[];G=10;J{j=10-G;21=0;20=e;J{c=e-20;21+=7.4[i][c]*M[c][j]}H(--20);4[i][j]=21}H(--G)}H(--d);9 M=S.u(4);8 b?M.2E(1):M},x:l(a){8 7.22(a)},32:l(a,b,c,d){9 e=[],12=c,i,G,j;9 f=7.4.q,1p=7.4[0].q;J{i=c-12;e[i]=[];G=d;J{j=d-G;e[i][j]=7.4[(a+i-1)%f][(b+j-1)%1p]}H(--G)}H(--12);8 S.u(e)},31:l(){9 a=7.4.q,1p=7.4[0].q;9 b=[],12=1p,i,G,j;J{i=1p-12;b[i]=[];G=a;J{j=a-G;b[i][j]=7.4[j][i]}H(--G)}H(--12);8 S.u(b)},1y:l(){8(7.4.q==7.4[0].q)},2A:l(){9 m=0,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(F.13(7.4[i][j])>F.13(m)){m=7.4[i][j]}}H(--G)}H(--12);8 m},2Z:l(x){9 a=w,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(7.4[i][j]==x){8{i:i+1,j:j+1}}}H(--G)}H(--12);8 w},30:l(){o(!7.1y){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][i])}H(--n);8 v.u(a)},1K:l(){9 M=7.1q(),1c;9 n=7.4.q,k=n,i,1s,1n=7.4[0].q,p;J{i=k-n;o(M.4[i][i]==0){2e(j=i+1;j<k;j++){o(M.4[j][i]!=0){1c=[];1s=1n;J{p=1n-1s;1c.19(M.4[i][p]+M.4[j][p])}H(--1s);M.4[i]=1c;1I}}}o(M.4[i][i]!=0){2e(j=i+1;j<k;j++){9 a=M.4[j][i]/M.4[i][i];1c=[];1s=1n;J{p=1n-1s;1c.19(p<=i?0:M.4[j][p]-M.4[i][p]*a)}H(--1s);M.4[j]=1c}}}H(--n);8 M},3h:l(){8 7.1K()},2z:l(){o(!7.1y()){8 w}9 M=7.1K();9 a=M.4[0][0],n=M.4.q-1,k=n,i;J{i=k-n+1;a=a*M.4[i][i]}H(--n);8 a},3f:l(){8 7.2z()},2y:l(){8(7.1y()&&7.2z()===0)},2Y:l(){o(!7.1y()){8 w}9 a=7.4[0][0],n=7.4.q-1,k=n,i;J{i=k-n+1;a+=7.4[i][i]}H(--n);8 a},3e:l(){8 7.2Y()},1Y:l(){9 M=7.1K(),1Y=0;9 a=7.4.q,15=a,i,G,10=7.4[0].q,j;J{i=15-a;G=10;J{j=10-G;o(F.13(M.4[i][j])>17.16){1Y++;1I}}H(--G)}H(--a);8 1Y},3d:l(){8 7.1Y()},2W:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}9 T=7.1q(),1p=T.4[0].q;9 b=T.4.q,15=b,i,G,10=M[0].q,j;o(b!=M.q){8 w}J{i=15-b;G=10;J{j=10-G;T.4[i][1p+j]=M[i][j]}H(--G)}H(--b);8 T},2w:l(){o(!7.1y()||7.2y()){8 w}9 a=7.4.q,15=a,i,j;9 M=7.2W(S.I(a)).1K();9 b,1n=M.4[0].q,p,1c,2v;9 c=[],2c;J{i=a-1;1c=[];b=1n;c[i]=[];2v=M.4[i][i];J{p=1n-b;2c=M.4[i][p]/2v;1c.19(2c);o(p>=15){c[i].19(2c)}}H(--b);M.4[i]=1c;2e(j=0;j<i;j++){1c=[];b=1n;J{p=1n-b;1c.19(M.4[j][p]-M.4[i][p]*M.4[j][i])}H(--b);M.4[j]=1c}}H(--a);8 S.u(c)},3c:l(){8 7.2w()},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(p){8(F.13(p-x)<=17.16)?x:p})},2n:l(){9 a=[];9 n=7.4.q,k=n,i;J{i=k-n;a.19(v.u(7.4[i]).2n())}H(--n);8 a.2K('\\n')},26:l(a){9 i,4=a.4||a;o(1g(4[0][0])!='1f'){9 b=4.q,15=b,G,10,j;7.4=[];J{i=15-b;G=4[i].q;10=G;7.4[i]=[];J{j=10-G;7.4[i][j]=4[i][j]}H(--G)}H(--b);8 7}9 n=4.q,k=n;7.4=[];J{i=k-n;7.4.19([4[i]])}H(--n);8 7}};S.u=l(a){9 M=25 S();8 M.26(a)};S.I=l(n){9 a=[],k=n,i,G,j;J{i=k-n;a[i]=[];G=k;J{j=k-G;a[i][j]=(i==j)?1:0}H(--G)}H(--n);8 S.u(a)};S.2X=l(a){9 n=a.q,k=n,i;9 M=S.I(n);J{i=k-n;M.4[i][i]=a[i]}H(--n);8 M};S.1R=l(b,a){o(!a){8 S.u([[F.1H(b),-F.1G(b)],[F.1G(b),F.1H(b)]])}9 d=a.1q();o(d.4.q!=3){8 w}9 e=d.1u();9 x=d.4[0]/e,y=d.4[1]/e,z=d.4[2]/e;9 s=F.1G(b),c=F.1H(b),t=1-c;8 S.u([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]])};S.3b=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[1,0,0],[0,c,-s],[0,s,c]])};S.39=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,0,s],[0,1,0],[-s,0,c]])};S.38=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,-s,0],[s,c,0],[0,0,1]])};S.2J=l(n,m){8 S.1j(n,m).1b(l(){8 F.2F()})};S.1j=l(n,m){9 a=[],12=n,i,G,j;J{i=n-12;a[i]=[];G=m;J{j=m-G;a[i][j]=0}H(--G)}H(--12);8 S.u(a)};l 14(){}14.23={24:l(a){8(7.1m(a)&&7.1h(a.K))},1q:l(){8 14.u(7.K,7.U)},2U:l(a){9 V=a.4||a;8 14.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.U)},1m:l(a){o(a.W){8 a.1m(7)}9 b=7.U.1C(a.U);8(F.13(b)<=17.16||F.13(b-F.1A)<=17.16)},1o:l(a){o(a.W){8 a.1o(7)}o(a.U){o(7.1m(a)){8 7.1o(a.K)}9 N=7.U.2f(a.U).2q().4;9 A=7.K.4,B=a.K.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,D=7.U.4;9 b=P[0]-A[0],2a=P[1]-A[1],29=(P[2]||0)-A[2];9 c=F.1x(b*b+2a*2a+29*29);o(c===0)8 0;9 d=(b*D[0]+2a*D[1]+29*D[2])/c;9 e=1-d*d;8 F.13(c*F.1x(e<0?0:e))}},1h:l(a){9 b=7.1o(a);8(b!==w&&b<=17.16)},2T:l(a){8 a.1h(7)},1v:l(a){o(a.W){8 a.1v(7)}8(!7.1m(a)&&7.1o(a)<=17.16)},1U:l(a){o(a.W){8 a.1U(7)}o(!7.1v(a)){8 w}9 P=7.K.4,X=7.U.4,Q=a.K.4,Y=a.U.4;9 b=X[0],1z=X[1],1B=X[2],1T=Y[0],1S=Y[1],1M=Y[2];9 c=P[0]-Q[0],2s=P[1]-Q[1],2r=P[2]-Q[2];9 d=-b*c-1z*2s-1B*2r;9 e=1T*c+1S*2s+1M*2r;9 f=b*b+1z*1z+1B*1B;9 g=1T*1T+1S*1S+1M*1M;9 h=b*1T+1z*1S+1B*1M;9 k=(d*g/f+h*e)/(g-h*h);8 v.u([P[0]+k*b,P[1]+k*1z,P[2]+k*1B])},1r:l(a){o(a.U){o(7.1v(a)){8 7.1U(a)}o(7.1m(a)){8 w}9 D=7.U.4,E=a.U.4;9 b=D[0],1l=D[1],1k=D[2],1P=E[0],1O=E[1],1Q=E[2];9 x=(1k*1P-b*1Q),y=(b*1O-1l*1P),z=(1l*1Q-1k*1O);9 N=v.u([x*1Q-y*1O,y*1P-z*1Q,z*1O-x*1P]);9 P=11.u(a.K,N);8 P.1U(7)}1d{9 P=a.4||a;o(7.1h(P)){8 v.u(P)}9 A=7.K.4,D=7.U.4;9 b=D[0],1l=D[1],1k=D[2],1w=A[0],18=A[1],1a=A[2];9 x=b*(P[1]-18)-1l*(P[0]-1w),y=1l*((P[2]||0)-1a)-1k*(P[1]-18),z=1k*(P[0]-1w)-b*((P[2]||0)-1a);9 V=v.u([1l*x-1k*z,1k*y-b*x,b*z-1l*y]);9 k=7.1o(P)/V.1u();8 v.u([P[0]+V.4[0]*k,P[1]+V.4[1]*k,(P[2]||0)+V.4[2]*k])}},1V:l(t,a){o(1g(a.U)=='1f'){a=14.u(a.1N(),v.k)}9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,D=7.U.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 14.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]])},1t:l(a){o(a.W){9 A=7.K.4,D=7.U.4;9 b=A[0],18=A[1],1a=A[2],2N=D[0],1l=D[1],1k=D[2];9 c=7.K.1t(a).4;9 d=b+2N,2h=18+1l,2o=1a+1k;9 Q=a.1r([d,2h,2o]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2h)-c[1],Q[2]+(Q[2]-2o)-c[2]];8 14.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 14.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.U)}},1Z:l(a,b){a=v.u(a);b=v.u(b);o(a.4.q==2){a.4.19(0)}o(b.4.q==2){b.4.19(0)}o(a.4.q>3||b.4.q>3){8 w}9 c=b.1u();o(c===0){8 w}7.K=a;7.U=v.u([b.4[0]/c,b.4[1]/c,b.4[2]/c]);8 7}};14.u=l(a,b){9 L=25 14();8 L.1Z(a,b)};14.X=14.u(v.1j(3),v.i);14.Y=14.u(v.1j(3),v.j);14.Z=14.u(v.1j(3),v.k);l 11(){}11.23={24:l(a){8(7.1h(a.K)&&7.1m(a))},1q:l(){8 11.u(7.K,7.W)},2U:l(a){9 V=a.4||a;8 11.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.W)},1m:l(a){9 b;o(a.W){b=7.W.1C(a.W);8(F.13(b)<=17.16||F.13(F.1A-b)<=17.16)}1d o(a.U){8 7.W.2k(a.U)}8 w},2k:l(a){9 b=7.W.1C(a.W);8(F.13(F.1A/2-b)<=17.16)},1o:l(a){o(7.1v(a)||7.1h(a)){8 0}o(a.K){9 A=7.K.4,B=a.K.4,N=7.W.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;8 F.13((A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2])}},1h:l(a){o(a.W){8 w}o(a.U){8(7.1h(a.K)&&7.1h(a.K.2j(a.U)))}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=F.13(N[0]*(A[0]-P[0])+N[1]*(A[1]-P[1])+N[2]*(A[2]-(P[2]||0)));8(b<=17.16)}},1v:l(a){o(1g(a.U)=='1f'&&1g(a.W)=='1f'){8 w}8!7.1m(a)},1U:l(a){o(!7.1v(a)){8 w}o(a.U){9 A=a.K.4,D=a.U.4,P=7.K.4,N=7.W.4;9 b=(N[0]*(P[0]-A[0])+N[1]*(P[1]-A[1])+N[2]*(P[2]-A[2]))/(N[0]*D[0]+N[1]*D[1]+N[2]*D[2]);8 v.u([A[0]+D[0]*b,A[1]+D[1]*b,A[2]+D[2]*b])}1d o(a.W){9 c=7.W.2f(a.W).2q();9 N=7.W.4,A=7.K.4,O=a.W.4,B=a.K.4;9 d=S.1j(2,2),i=0;H(d.2y()){i++;d=S.u([[N[i%3],N[(i+1)%3]],[O[i%3],O[(i+1)%3]]])}9 e=d.2w().4;9 x=N[0]*A[0]+N[1]*A[1]+N[2]*A[2];9 y=O[0]*B[0]+O[1]*B[1]+O[2]*B[2];9 f=[e[0][0]*x+e[0][1]*y,e[1][0]*x+e[1][1]*y];9 g=[];2e(9 j=1;j<=3;j++){g.19((i==j)?0:f[(j+(5-i)%3)%3])}8 14.u(g,c)}},1r:l(a){9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=(A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2];8 v.u([P[0]+N[0]*b,P[1]+N[1]*b,(P[2]||0)+N[2]*b])},1V:l(t,a){9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,N=7.W.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 11.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*N[0]+R[0][1]*N[1]+R[0][2]*N[2],R[1][0]*N[0]+R[1][1]*N[1]+R[1][2]*N[2],R[2][0]*N[0]+R[2][1]*N[1]+R[2][2]*N[2]])},1t:l(a){o(a.W){9 A=7.K.4,N=7.W.4;9 b=A[0],18=A[1],1a=A[2],2M=N[0],2L=N[1],2Q=N[2];9 c=7.K.1t(a).4;9 d=b+2M,2p=18+2L,2m=1a+2Q;9 Q=a.1r([d,2p,2m]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2p)-c[1],Q[2]+(Q[2]-2m)-c[2]];8 11.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 11.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.W)}},1Z:l(a,b,c){a=v.u(a);a=a.1N();o(a===w){8 w}b=v.u(b);b=b.1N();o(b===w){8 w}o(1g(c)=='1f'){c=w}1d{c=v.u(c);c=c.1N();o(c===w){8 w}}9 d=a.4[0],18=a.4[1],1a=a.4[2];9 e=b.4[0],1W=b.4[1],1X=b.4[2];9 f,1i;o(c!==w){9 g=c.4[0],2l=c.4[1],2t=c.4[2];f=v.u([(1W-18)*(2t-1a)-(1X-1a)*(2l-18),(1X-1a)*(g-d)-(e-d)*(2t-1a),(e-d)*(2l-18)-(1W-18)*(g-d)]);1i=f.1u();o(1i===0){8 w}f=v.u([f.4[0]/1i,f.4[1]/1i,f.4[2]/1i])}1d{1i=F.1x(e*e+1W*1W+1X*1X);o(1i===0){8 w}f=v.u([b.4[0]/1i,b.4[1]/1i,b.4[2]/1i])}7.K=a;7.W=f;8 7}};11.u=l(a,b,c){9 P=25 11();8 P.1Z(a,b,c)};11.2I=11.u(v.1j(3),v.k);11.2H=11.u(v.1j(3),v.i);11.2G=11.u(v.1j(3),v.j);11.36=11.2I;11.35=11.2H;11.3j=11.2G;9 $V=v.u;9 $M=S.u;9 $L=14.u;9 $P=11.u;",62,206,"||||elements|||this|return|var||||||||||||function|||if||length||||create|Vector|null|||||||||Math|nj|while||do|anchor||||||||Matrix||direction||normal||||kj|Plane|ni|abs|Line|ki|precision|Sylvester|A2|push|A3|map|els|else||undefined|typeof|contains|mod|Zero|D3|D2|isParallelTo|kp|distanceFrom|cols|dup|pointClosestTo|np|reflectionIn|modulus|intersects|A1|sqrt|isSquare|X2|PI|X3|angleFrom|mod1|C2|mod2|sin|cos|break|C3|toRightTriangular|false|Y3|to3D|E2|E1|E3|Rotation|Y2|Y1|intersectionWith|rotate|v12|v13|rank|setVectors|nc|sum|multiply|prototype|eql|new|setElements|case|each|PA3|PA2|part|new_element|round|for|cross|product|AD2|isSameSizeAs|add|isPerpendicularTo|v22|AN3|inspect|AD3|AN2|toUnitVector|PsubQ3|PsubQ2|v23|dot|divisor|inverse|true|isSingular|determinant|max|canMultiplyFromLeft|subtract|rows|col|random|ZX|YZ|XY|Random|join|N2|N1|D1|slice|default|N3|dimensions|switch|liesIn|translate|snapTo|augment|Diagonal|trace|indexOf|diagonal|transpose|minor|row|isAntiparallelTo|ZY|YX|acos|RotationZ|RotationY|liesOn|RotationX|inv|rk|tr|det|toDiagonalMatrix|toUpperTriangular|version|XZ".split("|"),0,{})),define("sylvester",function(){}),function(){define("rotate",["underscore","sylvester"],function(e,t){return function(){function t(){}return t.action=function(t){var n,r,i,s,o,u,a;return console.log("rotating"),r=t.group,i=t.item,o=function(){var e;e=[];for(n in t.corners)e.push(t.corners[n]);return e}(),a={x:i.attrs.x+i.attrs.width/2,y:i.attrs.y+i.attrs.height/2},s=Vector.create([a.x,a.y]),console.log(a),u={x:0,y:0},e.each(o,function(e){return e.show(),e.on("dragstart",function(){return r.setDraggable(!1),u.x=e.attrs.x,u.y=e.attrs.y}),e.on("dragend",function(){return r.setDraggable(!0)}),e.on("dragmove",function(e){var t,n,i;return console.log(this),console.log("drag start "+u.x+", "+u.y),n=Vector.create([u.x,u.y]),t=Vector.create([this.attrs.x,this.attrs.y]),i=t.angleFrom(n),console.log("theta: "+i*360/Math.PI),r.rotate(i)})}),i.getLayer().draw()},t}()})}.call(this),function(){define("commands",["require","ResizeCommand","rotate"],function(e){return{resize:e("ResizeCommand"),rotate:e("rotate")}})}.call(this);