// Generated by CoffeeScript 1.4.0
(function() {

  define(['jqueryUI', 'kinetic', 'EventEmitter', 'Photo'], function($, Kinetic, event_emitter, Photo) {
    var Collage;
    return Collage = (function() {

      function Collage(canvas_element) {
        var image_dropped,
          _this = this;
        this.canvas_element = canvas_element;
        this.canvas = $("#" + this.canvas_element);
        this.stage = new Kinetic.Stage({
          container: canvas_element,
          width: this.canvas.width(),
          height: this.canvas.height()
        });
        this.layer = new Kinetic.Layer();
        this.container = new Kinetic.Container();
        this.stage.add(this.layer);
        this.activeImage = null;
        this.collage_items = [];
        image_dropped = function(evt, ui) {
          var img, img_data;
          console.log("photo image dropped");
          img = $(ui.draggable);
          img_data = {
            offsetX: evt.offsetX,
            offsetY: evt.offsetY,
            data: img.data('img_data')
          };
          console.log(img_data);
          return _this.addFbPhoto(img_data);
        };
        this.canvas.find('canvas').droppable({
          drop: image_dropped
        });
        this.canvas.on("click", function(evt) {
          var cnvs_item;
          console.log("canvas clicked");
          cnvs_item = _this.find_item(evt.offsetX, evt.offsetY);
          console.log(cnvs_item);
          if ((_this.currentItem != null) && cnvs_item.length === 0) {
            console.log("de selecting current canvas item");
            _this.currentItem.noLongerActive();
            return _this.currentItem = null;
          } else {
            console.log("collage item selected");
            _this.currentItem = cnvs_item;
            return event_emitter.emit("ItemSelected", _this.currentItem.itemType, _this.currentItem);
          }
        });
        event_emitter.on("rotation.changed", function(value) {
          var _ref;
          return (_ref = _this.currentItem) != null ? _ref.rotate(value) : void 0;
        });
      }

      Collage.prototype.dimensions = function() {
        return this.stage.getSize();
      };

      Collage.prototype.screenPosition = function() {
        return this.canvas.position();
      };

      Collage.prototype.addImage = function(imageSrc) {
        var canvas_image, onImageCreated,
          _this = this;
        console.log("adding image");
        onImageCreated = function(k_image) {
          _this.container.add(k_image);
          _this.layer.add(k_image);
          return _this.stage.draw();
        };
        canvas_image = new Photo(imageSrc, onImageCreated);
        return this.collage_items.push(canvas_image);
      };

      Collage.prototype.find_item = function(x, y) {
        var i;
        return ((function() {
          var _i, _len, _ref, _results;
          _ref = this.collage_items;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            i = _ref[_i];
            if (i.intersects(x, y)) {
              _results.push(i);
            }
          }
          return _results;
        }).call(this))[0];
      };

      Collage.prototype.addFbPhoto = function(image_data) {
        var collage_dimensions, imageToAdd;
        collage_dimensions = this.dimensions();
        imageToAdd = _.find(image_data.data.images, function(image) {
          return image.width <= collage_dimensions.width && image.height <= collage_dimensions.height;
        });
        return this.addImage({
          src: '/images?src=' + imageToAdd.source,
          width: imageToAdd.width,
          height: imageToAdd.height,
          x: image_data.offsetX,
          y: image_data.offsetY
        });
      };

      return Collage;

    })();
  });

}).call(this);
